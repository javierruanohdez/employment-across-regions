---
title: "Employment Across Regions"
output:
  flexdashboard::flex_dashboard:
    vertical_layout: fill
runtime: shiny
---

```{r global, include=FALSE}
library(pxR)
library(MASS)
library(shinydashboard)
library(datasets)
library(highcharter) 
library(fpp3)
library(RColorBrewer)
library(openxlsx)  
library(leaflet)  
library(geojsonio)
library(plotly)
library(ggplot2)
library(tidyverse)
library(base64enc)
source("utilidades.R")
pdf(file = NULL) # evita errores en shiny 

# asociamos funciones a determinadas librer√≠as para evitar posibles errores 
filter <- dplyr::filter # Filtra filas seg√∫n condiciones
select <- dplyr::select # Selecciona columnas
mutate <- dplyr::mutate # Crea o modifica columnas
arrange <- dplyr::arrange # Ordena filas
group_by <- dplyr::group_by # Agrupa datos
summarise <- dplyr::summarise # Resume variables (por ejemplo, con medias, conteos)
summarize <- dplyr::summarize # Lo mismo que summarise
rename <- dplyr::rename # Cambia nombres de columnas
distinct <- dplyr::distinct # Elimina filas duplicadas
slice<- dplyr::slice # Selecciona filas por posici√≥n
relocate<- dplyr::relocate # Reordena columnas
selectInput <- shiny::selectInput
```


```{css, echo=FALSE}

  /* ====== AJUSTES PARA MAPAS LEAFLET ====== */
  .leaflet, .leaflet-container {
    height: calc(100vh - 150px) !important;
    min-height: 500px !important;
    max-height: 85vh !important;
  }
  
  
  /* El scroll interno de DataTables */
  .dataTables_scroll {
    flex: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    min-height: 0 !important;
  }
  
  /* Cuerpo scrollable de la tabla */
  .dataTables_scrollBody {
    max-height: calc(100vh - 630px) !important;
    height: auto !important;
    flex: 1 !important;
    min-height: 200px;
    overflow-y: auto !important;
  }
  
  /* Asegurar que la tabla ocupe todo el ancho */
  .dataTables_scrollBody table {
    width: 100% !important;
    margin-bottom: 0 !important;
  }
  
  /* Cabecera fija */
  .dataTables_scrollHead {
    flex-shrink: 0 !important;
  }
  
  .dataTables_scrollHead table {
    width: 100% !important;
    margin-bottom: 0 !important;
  }
  
  /* Eliminar m√°rgenes innecesarios */
  .dataTables_info, .dataTables_length, .dataTables_filter {
    margin: 5px 0 !important;
    padding: 0 !important;
  }
  
  .sticky-controls {
  position: sticky;
  top: 0;
  z-index: 9999;
  background: white;
  padding: 10px;
}
```

```{css, echo=FALSE}
tags$script(HTML("
  document.querySelectorAll('.tabset .nav a').forEach(function(tabLink) {
    tabLink.addEventListener('shown.bs.tab', function(e) {
      // Retardo para asegurar que el DOM es visible
      setTimeout(function(){
        Shiny.setInputValue('tab_changed', e.target.textContent.trim(), {priority: 'event'});
      }, 100);
    });
  });
"))
```

```{r}
# ---- Required data bootstrap (Posit Connect safe) ----
# Directorios
required_path <- "required_data"
dashboard_path <- "."  # Donde est√° el Rmd

# Crear carpeta datasets si no existe
datasets_dir <- file.path(required_path, "datasets")
if (!dir.exists(datasets_dir)) dir.create(datasets_dir, recursive = TRUE)

# ---- Funci√≥n para aplanar un ZIP ----
unzip_flat <- function(zipfile, target_dir) {
  if (!file.exists(zipfile)) return()
  z_files <- unzip(zipfile, list = TRUE)$Name
  for (f in z_files) {
    # ignorar carpetas
    if (grepl("/$", f)) next
    # extraer a tempdir
    unzip(zipfile, files = f, exdir = tempdir())
    # mover al target_dir con basename
    file.rename(file.path(tempdir(), f), file.path(target_dir, basename(f)))
  }
}

# ---- Descomprimir datasets ----
datasets_zips <- c("required_datasets1.zip", "required_datasets2.zip")
for (zipf in datasets_zips) {
  unzip_flat(file.path(required_path, zipf), datasets_dir)
}

# ---- Descomprimir geos ----
geos_dir <- file.path(required_path, "geos")
if (!dir.exists(geos_dir)) dir.create(geos_dir, recursive = TRUE)
unzip_flat(file.path(required_path, "required_geos.zip"), geos_dir)

# ---- Descomprimir im√°genes DIRECTO al directorio del Rmd ----
imgs_zip <- file.path(required_path, "required_imgs.zip")
if (file.exists(imgs_zip)) {
  unzip_flat(imgs_zip, dashboard_path)
}
```



```{r}
EMPLEO <- readr::read_csv("required_data/datasets/EMPLEO.csv")

EMPLEO_Sectores <- EMPLEO %>%
  mutate(sector = case_when(
    nace_r2 %in% c("A") ~ "Primario",
    nace_r2 %in% c("B-E","C","F") ~ "Secundario",
    nace_r2 %in% c("G-J","K-N","O-U") ~ "Terciario",
    TRUE ~ NA_character_
  )) %>%
  filter(!is.na(sector))

TASA_EMPLEO <- readr::read_csv("required_data/datasets/TASA_EMPLEO.csv") %>%
  as_tibble()

GENDER_GAP <- TASA_EMPLEO %>%
  filter(sex != T) %>%
  pivot_wider(
    names_from = sex,      
    values_from = emp_rate,
  ) %>%
  mutate(gender_gap = M - F)
  
KEY_INDICATORS <- readr::read_csv("required_data/datasets/KEY_INDICATORS.csv") %>%
  as_tibble()

emp_pareto_UE <- EMPLEO %>%
  filter(NUTS == 0, EU27_2020 == "SI", wstatus == "EMP", nace_r2 == "TOTAL", TIME_PERIOD == 2022) %>%
  filter(employment > ParetoValue(employment, 0.8)) %>%
  arrange(employment) %>%
  mutate(full_name=factor(full_name,levels=unique(full_name)))

geoj_0 <- geojson_read("required_data/geos/geoj_0.geojson",  what = "sp")
geoj_1 <- geojson_read("required_data/geos/geoj_1.geojson",  what = "sp")
geoj_2 <- geojson_read("required_data/geos/geoj_2.geojson",  what = "sp")
geoj_3 <- geojson_read("required_data/geos/geoj_3.geojson",  what = "sp")

geoj <- list(geoj_0, geoj_1, geoj_2, geoj_3)

coord_0 <- readr::read_csv("required_data/geos/eu_nuts0_coords.csv") %>% as_tibble()
coord_1 <- readr::read_csv("required_data/geos/eu_nuts1_coords.csv") %>% as_tibble() %>% mutate(Latitude = as.numeric(Latitude))
coord_2 <- readr::read_csv("required_data/geos/eu_nuts2_coords.csv") %>% as_tibble() %>% mutate(Latitude = as.numeric(Latitude))
coord_3 <- readr::read_csv("required_data/geos/eu_nuts3_coords.csv") %>% as_tibble() %>% mutate(Latitude = as.numeric(Latitude), Longitude = as.numeric(Longitude))

coord <- list(coord_0, coord_1, coord_2, coord_3)

Islas_Canarias <- c("Gran Canaria", "Tenerife", "Fuerteventura", "Lanzarote", "La Gomera", "La Palma", "El Hierro") 

CONTRATOS_2018_2024 <- readr::read_csv("required_data/datasets/CONTRATOS_2018_2024.csv") %>% as_tibble()

INSERCION_LABORAL <- readr::read_csv("required_data/datasets/INSERCION_LABORAL.csv") %>% as_tibble()

EMPLEO_MUNICIPIOS <- readr::read_csv("required_data/datasets/EMPLEO_MUNICIPIOS.csv") %>% as_tibble() %>% select(-geom) %>%
  mutate(temp_t = 100-tpar_t, temp_m = 100-tpar_m, temp_f = 100-tpar_f) %>% 
  relocate((temp_t:temp_f), .after = psel_f)

municipios.geoj <- geojson_read("required_data/geos/geo_canarias_municipios.geojson",  what = "sp")

municipios.geoj.tb <- municipios.geoj %>% 
  as_tibble() %>%
  select(municipio=etiqueta)

nuts0 <- intersect(unique(EMPLEO %>% filter(NUTS == 0) %>% pull(full_name)), unique(TASA_EMPLEO %>% filter(NUTS == 0) %>% pull(full_name)))
nuts1 <- intersect(unique(EMPLEO %>% filter(NUTS == 1) %>% pull(full_name)), unique(TASA_EMPLEO %>% filter(NUTS == 1) %>% pull(full_name)))
nuts2 <- intersect(unique(EMPLEO %>% filter(NUTS == 2) %>% pull(full_name)), unique(TASA_EMPLEO %>% filter(NUTS == 2) %>% pull(full_name)))
nuts3 <- intersect(unique(EMPLEO %>% filter(NUTS == 3) %>% pull(full_name)), unique(TASA_EMPLEO %>% filter(NUTS == 3) %>% pull(full_name)))
```

```{r}
observeEvent(input$tab_changed, {
  
  if(input$tab_changed == "EuroMap Explorer") {
    # Recalcula mapas EuroMaps con delay
    invalidateLater(200, session)
    outputIds <- c("mapa_empleo_regiones", "mapa_empleo_sexo_edad", "mapa_key_indicators")
    lapply(outputIds, function(id){
      leafletProxy(id) %>% invalidateSize()
    })
    
  } else if(input$tab_changed == "Canary Insights") {
    invalidateLater(200, session)
    leafletProxy("mapa_municipios") %>% invalidateSize()
  }
})

```


Intro
=====================================================================

```{r}
tags$div(
  id = "intro-page",
  style = "
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    text-align: center;
    gap: 15px;
    padding: 20px 20px 10px 20px;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 98vh;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    overflow-y: hidden;
  ",

  # T√≠tulo principal
  tags$h1(
    "üíº Employment Across Regions",
    style = "
      font-size: 2.8em;
      font-weight: 800;
      color: #2C3E50;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
      animation: fadeIn 1.5s;
      margin-bottom: 5px;
      margin-top: 1; 
    "
  ),

  # Breve descripci√≥n
  tags$div(
    "Explora la evoluci√≥n del empleo en distintas regiones de Europa y Espa√±a, incluyendo un enfoque en las Islas Canarias. Analiza indicadores clave, participaci√≥n sectorial, brechas de g√©nero y tendencias por edad en un entorno visual e interactivo.",
    style = "max-width: 900px; font-size: 1.1em; color: #34495E; line-height: 1.5em; animation: fadeIn 2s; margin-bottom: 5px;"
  ),

  # Secci√≥n de herramientas (3 cajas en una misma l√≠nea)
  tags$div(
    style = "
      display: flex;
      justify-content: center;
      gap: 15px;
      width: 100%;
      max-width: 1000px;
      animation: fadeIn 2.5s;
      margin-bottom: 10px;
    ",

    tags$div(
      style = "
        background: #1ABC9C;
        color: white;
        padding: 10px 20px;
        border-radius: 12px;
        font-weight: 700;
        min-width: 230px;
        font-size: 0.95em;
      ",
      "R | Shiny | Flexdashboard"
    ),

    tags$div(
      style = "
        background: #3498DB;
        color: white;
        padding: 10px 20px;
        border-radius: 12px;
        font-weight: 700;
        min-width: 230px;
        font-size: 0.95em;
      ",
      "tidyverse | geojsonio | MASS | fpp3"
    ),

    tags$div(
      style = "
        background: #9B59B6;
        color: white;
        padding: 10px 20px;
        border-radius: 12px;
        font-weight: 700;
        min-width: 230px;
        font-size: 0.95em;
      ",
      "ggplot2 | Plotly | Highcharter | Leaflet"
    )
  ),

  # Bloque de tarjetas (SOLO 2 CAJAS)
  tags$div(
    style = "display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; max-width: 900px; margin-bottom: 20px;",

    # Contenidos
    tags$div(
      style = "
        background: white;
        border-radius: 15px;
        padding: 25px;
        width: 380px;
        min-height: 300px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        transition: transform 0.3s;
      ",
      tags$h3("üìö Contenidos", style="color: #2E86C1; font-size: 1.3em; font-weight: 800; margin-bottom: 15px;"),
      tags$ul(
        style="text-align: left; list-style-type: square; padding-left: 20px; font-size: 1em; line-height: 1.5em;",
        tags$li("Evoluci√≥n del empleo regional y nacional"),
        tags$li("Participaci√≥n sectorial seg√∫n NACE Rev. 2"),
        tags$li("Brecha de g√©nero y an√°lisis por edad"),
        tags$li("Series temporales y predicciones ARIMA"),
        tags$li("Mapas interactivos e indicadores clave"),
        tags$li("An√°lisis de correlaci√≥n y componentes principales"),
        tags$li("Indicadores laborales espec√≠ficos de Canarias"),
      )
    ),

    # Objetivos
    tags$div(
      style = "
        background: white;
        border-radius: 15px;
        padding: 25px;
        width: 380px;
        min-height: 300px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        transition: transform 0.3s;
      ",
      tags$h3("üéØ Objetivos", style="color: #2E86C1; font-size: 1.3em; font-weight: 800; margin-bottom: 15px;"),
      tags$ul(
        style="text-align: left; list-style-type: square; padding-left: 20px; font-size: 1em; line-height: 1.5em;",
        tags$li("Visualizar tendencias de empleo a nivel regional y por sector"),
        tags$li("Identificar brechas de g√©nero y diferencias por edad"),
        tags$li("Facilitar comparaci√≥n entre regiones y pa√≠ses"),
        tags$li("Analizar correlaciones entre indicadores econ√≥micos"),
        tags$li("Proyectar tendencias futuras mediante modelos ARIMA")
      )
    )
  ),

  # Plataformas de datos EN HORIZONTAL - SUBIDA M√ÅS ARRIBA
  tags$div(
    style = "
      background: white;
      border-radius: 15px;
      padding: 20px 25px;
      width: 100%;
      max-width: 800px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      animation: fadeIn 3s;
      margin-bottom: 15px;
    ",
    tags$h3("üìÅ Fuentes de datos", style="color: #2E86C1; font-size: 1.3em; font-weight: 800; margin-bottom: 20px; text-align: center;"),
    tags$div(
      style = "display: flex; justify-content: space-between; align-items: center; gap: 10px;",

      tags$div(
        style = "display: flex; justify-content: center; flex: 1;",
        tags$a(
          href = "https://ec.europa.eu/eurostat", # 
          target = "_blank", # Abre el enlace en una nueva pesta√±a
          tags$img(src = "eurostat_logo.png", class = "img-plataforma", style = "height: 55px; object-fit: contain; max-width: 100%;")
        )
      ),

      # 2. ISTAC (Con Hiperv√≠nculo)
      tags$div(
        style = "display: flex; justify-content: center; flex: 1;",
        tags$a(
          href = "https://www.gobiernodecanarias.org/istac/", 
          target = "_blank", 
          tags$img(src = "istac_logo_3.jpg", class = "img-plataforma", style = "height: 55px; object-fit: contain; max-width: 100%;")
        )
      ),

      # 3. OBECAN (Con Hiperv√≠nculo - Reemplazar la URL de ejemplo)
      tags$div(
        style = "display: flex; justify-content: center; flex: 1;",
        tags$a(
          href = "https://obecan.es/",
          target = "_blank", 
          tags$img(src = "obecan_logo.png", class = "img-plataforma", style = "height: 55px; object-fit: contain; max-width: 100%;")
        )
      ),

      # 4. OWID (Con Hiperv√≠nculo - Reemplazar la URL de ejemplo)
      tags$div(
        style = "display: flex; justify-content: center; flex: 1;",
        tags$a(
          href = "https://ourworldindata.org/",
          target = "_blank", 
          tags$img(src = "owid_logo.webp", class = "img-plataforma", style = "height: 55px; object-fit: contain; max-width: 100%;")
        )
      )
    )
  ),

  # Call to Action
  tags$div(
    class = "cta-animada",
    style = "
      margin-top: 10px;
      font-size: 1.2em;
      color: #2E86C1;
      font-weight: 700;
      animation: bounce 2s infinite;
      padding: 12px 25px;
      background: rgba(255,255,255,0.9);
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    ",
    "üöÄ Para explorar el dashboard, selecciona la pesta√±a ",
    tags$strong("Overview")
  ),

  # Animaciones CSS
  tags$style(HTML("
    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(20px);}
      to {opacity: 1; transform: translateY(0);}
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }
    .img-plataforma {
  transition: transform 0.3s;
    }
    .img-plataforma:hover {
  transform: translateY(-5px) scale(1.05);
    }
  .cta-animada:hover {
  transform: translateY(-5px);
  }
  "))
)
```

Overwiew
=======================================================================

```{r}
div(
  style = "display: flex; align-items: center; gap: 10px;",
  div(
   style = "display: flex; flex-direction: column;",
   tags$label("NUTS", style = "margin-bottom: 3px;"),
    selectInput(
      "NUTS_a", 
      label = NULL,
      choices = c("‚Äî", unique(EMPLEO$NUTS)) %>%
        na.omit(),
      selected = "‚Äî"
    )
  ),
  div(
  style = "display: flex; flex-direction: column;",
   tags$label("Regi√≥n", style = "margin-bottom: 3px;"),
    selectInput(
      "Region_a", 
      label = NULL,
      choices = c("EU27_2020", unique(EMPLEO$geographic_group), "Spain", c("Canarias", "Gran Canaria", "Tenerife", "Fuerteventura", "Lanzarote", "La Gomera", "La Palma", "El Hierro")) %>%
        na.omit(),
      selected = "EU27_2020"
    )
  ),
  div(
    style = "display: flex; flex-direction: column;",
    tags$label("", style = "margin-bottom: 3px;"),
    radioButtons(
      "unidad_empleo",
      label = NULL,
      choices = c(
        "Miles de personas" = "employment",
        "Per c√°pita" = "emp_per_working_age"
      ),
      selected = "employment",
      inline = TRUE
    )
  )
)
```

```{r}
observeEvent(input$NUTS_a, {
  if (input$NUTS_a == "‚Äî") {
    updateSelectInput(
      session = session,
      inputId = "Region_a",
      choices = c("EU27_2020", unique(EMPLEO$geographic_group), "Spain", c("Canarias", "Gran Canaria", "Tenerife", "Fuerteventura", "Lanzarote", "La Gomera", "La Palma", "El Hierro")) %>%
        na.omit(),
      selected = "EU27_2020",
    )
  }
  else if (input$NUTS_a == "0") {
    updateSelectInput(
      session = session,
      inputId = "Region_a",
      choices = nuts0[nuts0 != "Norway"] %>%
        na.omit(),
      selected = "Spain",
    )
  }
  else if (input$NUTS_a == "1") {
    updateSelectInput(
      session = session,
      inputId = "Region_a",
      choices =  nuts1 %>%
        na.omit(),
      selected = "Centro (ES)",
    )
  }
  else if (input$NUTS_a == "2") {
    updateSelectInput(
      session = session,
      inputId = "Region_a",
      choices =  nuts2 %>%
        na.omit(),
      selected = "Canarias",
    )
  }
  else {
    updateSelectInput(
      session = session,
      inputId = "Region_a",
      choices =  nuts3 %>%
        na.omit(),
      selected = "Gran Canaria",
    )
  }
}
)
```


```{r}
inputs.processing.empleo_overview <- reactive({

if (input$NUTS_a == "‚Äî") {

if (input$Region_a == "EU27_2020") {
    tb <- EMPLEO %>% 
      filter(NUTS == 0, EU27_2020 == "SI", wstatus == "EMP")
  }
  else if (input$Region_a %in% unique(EMPLEO$geographic_group)) {
    tb <- EMPLEO %>% 
      filter(NUTS == 0, geographic_group == input$Region_a, wstatus == "EMP")
  }
  else if (input$Region_a == "Canarias") {
    tb <- EMPLEO %>% 
      filter(NUTS == 2, full_name == input$Region_a, wstatus == "EMP")
  }
  else if (input$Region_a %in% Islas_Canarias) {
    tb <- EMPLEO %>%
      filter(full_name == input$Region_a, wstatus == "EMP")
  }
  else {
    tb <- EMPLEO %>% 
      filter(NUTS == 0, full_name == input$Region_a, wstatus == "EMP")
  }
}

else {
    tb <- EMPLEO %>% 
      filter(NUTS == input$NUTS_a, full_name == input$Region_a, wstatus == "EMP")
  }
  
  return(tb)
})
```

Row
------------------------------
### **Evoluci√≥n del empleo üìà**
```{r}
renderPlotly({
  tb <- inputs.processing.empleo_overview()
  
  req(nrow(tb) > 0)
  
  ev_emp_UE <- tb %>%
  filter(nace_r2 == "TOTAL", TIME_PERIOD >= 2000 & TIME_PERIOD < 2023) %>%
  group_by(TIME_PERIOD) %>%
  summarise(employment_total = sum(employment, na.rm = TRUE), 
            emp_per_working_age_total = ifelse(input$Region_a %in% c("EU27_2020", "NORTH", "SOUTH", "WEST", "EST"), mean(emp_per_working_age, na.rm = TRUE), sum(emp_per_working_age, na.rm = TRUE))) %>%
  arrange(TIME_PERIOD) %>%
  mutate(
    x = TIME_PERIOD,
    xend = lead(TIME_PERIOD),
    y = .data[[ifelse(input$unidad_empleo == "employment", "employment_total", "emp_per_working_age_total")]],
    yend = lead(y),,
    trend = case_when(
      is.na(yend) ~ NA_character_,
      yend - y > 0 ~ "Crecimiento",
      yend - y < 0 ~ "Decrecimiento",
      TRUE ~ "Sin cambio"
    )
  ) %>%
  filter(!is.na(xend))

# Definir colores personalizados para las tendencias
colores_trend <- c(
  "Crecimiento" = "#2ECC71",   # verde
  "Decrecimiento" = "#E74C3C", # rojo
  "Sin cambio" = "#95A5A6"     # gris
)

# Crear gr√°fico interactivo directamente con plotly
p <- plot_ly()

# A√±adir un segmento por cada fila
for (i in 1:nrow(ev_emp_UE)) {
  p <- add_trace(
    p,
    type = "scatter",
    mode = "lines+markers",
    x = c(ev_emp_UE$x[i], ev_emp_UE$xend[i]),
    y = c(ev_emp_UE$y[i], ev_emp_UE$yend[i]),
    line = list(color = colores_trend[ev_emp_UE$trend[i]], width = 4),
    marker = list(size = 6, color = colores_trend[ev_emp_UE$trend[i]]),
    name = ev_emp_UE$trend[i],
    hoverinfo = "text",
    text = paste0(
      "<b>", ev_emp_UE$trend[i], "</b><br>",
      "A√±o: ", ev_emp_UE$x[i], "<br>",
      "Empleo: ", ev_emp_UE$y[i], "<br>"
    ),
    showlegend = FALSE
  )
}

ultimo <- tail(ev_emp_UE, 1)
p <- add_trace(
  p,
  type = "scatter",
  mode = "markers",
  x = ultimo$xend,
  y = ultimo$yend,
  marker = list(size = 6, color = colores_trend[ultimo$trend]),
  hoverinfo = "text",
  text = paste0(
    "<b>", ultimo$trend, "</b><br>",
    "A√±o: ", ultimo$xend, "<br>",
    "Empleo: ", ultimo$yend, "<br>"
  ),
  showlegend = FALSE
)

p <- layout(
  p,
  margin = list(t = 80),  # Ajustado para mejor espacio
  xaxis = list(
    title = list(text = ""),  # Quitamos el t√≠tulo del eje X
    tickmode = "array",
    tickvals = seq(2000, 2020, 5),
    ticktext = seq(2000, 2020, 5),
    showgrid = TRUE
  ),
  yaxis = list(
    title = list(text = ""),  # Visible el nombre de la columna
    showgrid = TRUE
  ),
  hoverlabel = list(bgcolor = "white", font = list(size = 12))
)

p
})
```

Row
--------------------------
### **Participaci√≥n sectorial üíº**
```{r}
div(
  style = "position: relative; width: 100%;",

  div(
    style = "
      position: absolute;
      top: 3px;
      right: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.85);
      padding: 0px 8px;
      border-radius: 4px;
      box-shadow: 0 0 4px rgba(0,0,0,0.2);
    ",
    checkboxInput(
      "mostrar_sectores",
      label = "NACE Rev. 2",
      value = TRUE,
      width = "100%"
    )
  ),

  renderPlotly({
  if (isFALSE(input$mostrar_sectores)) {


  colores_sectores <- c(
  "Primario"   = "#F1C40F",  
  "Secundario" = "#E91E63",  
  "Terciario"  = "#3498DB"  
  )

if (input$NUTS_a == "‚Äî") { 
  if (input$Region_a == "EU27_2020") {
    tb <- EMPLEO_Sectores %>% 
      filter(NUTS == 0, EU27_2020 == "SI", wstatus == "EMP")
  }
  else if (input$Region_a %in% unique(EMPLEO_Sectores$geographic_group)) {
    tb <- EMPLEO_Sectores %>% 
      filter(NUTS == 0, geographic_group == input$Region_a, wstatus == "EMP")
  }
  else if (input$Region_a == "Canarias") {
    tb <- EMPLEO_Sectores %>% 
      filter(NUTS == 2, full_name == input$Region_a, wstatus == "EMP")
  }
  else if (input$Region_a %in% Islas_Canarias) {
    tb <- EMPLEO_Sectores %>%
      filter(full_name == input$Region_a, wstatus == "EMP")
  }
  else {
    tb <- EMPLEO_Sectores %>% 
      filter(NUTS == 0, full_name == input$Region_a, wstatus == "EMP")
  }
}
else {
  tb <- EMPLEO_Sectores %>% 
      filter(NUTS == input$NUTS_a, full_name == input$Region_a, wstatus == "EMP")
}
  
  req(nrow(tb) > 0)
  
  tb <- tb %>% 
          filter(TIME_PERIOD == ifelse(input$Region_a == "Norway", 2021, 2022)) %>%
          group_by(sector) %>%
          summarise(participacion_sectorial = sum(emp_per_working_age, na.rm = TRUE)*100,
      .groups = "drop") %>%
    mutate(
      legend_label = case_when(
        sector == "Primario" ~ "Primario (Agric., ganad., pesca, miner√≠a)",
        sector == "Secundario" ~ "Secundario (Industria, construcci√≥n)",
        sector == "Terciario" ~ "Terciario (Servicios)"
      ),
      color = colores_sectores[sector] 
    ) %>%
    plot_ly(
      labels = ~legend_label,
      values = ~participacion_sectorial,
      marker = list(colors = ~color)
    ) %>%
    add_pie(
      textinfo = "none",
      hovertemplate = "%{label}: %{percent}<extra></extra>",
      domain = list(x = c(-0.1, 0.7), y = c(0.1, 0.9))
    ) %>%
    layout(
      height = 350, 
      width = NULL,
      showlegend = TRUE,
      legend = list(
        orientation = "v",
        x = 0.75,
        xanchor = "left",
        y = 0.45,
        yanchor = "middle",
        font = list(size = 14)
      ),
      margin = list(r = 150)
    )
}
    else {
    tb <- inputs.processing.empleo_overview() %>%
          filter(TIME_PERIOD == ifelse(input$Region_a == "Norway", 2021, 2022),
                 !nace_r2.name %in% c("Total actividades", "Finanzas/Inmob./Profesionales/Administraci√≥n"))

  
  jerarquia <- list(
    "Comer./Transp./Hostel." = "Comercio/Transporte/Hosteler√≠a/Info-Com",
    "Informaci√≥n/Comunic."  = "Comercio/Transporte/Hosteler√≠a/Info-Com",
    "Adm./Sanid./Educ./Defen." = "Adm./Sanid./Educ./Defen./Arte/Servicios"
    
  )

 
  for (general in names(jerarquia)) {
    sub <- jerarquia[[general]]
    if (sum(tb$nace_r2.name == sub, na.rm = TRUE) > 0) {
      tb <- tb %>% filter(nace_r2.name != general)
    }
  }

  
  tb <- tb %>%
    group_by(nace_r2, nace_r2.name) %>%
    summarise(participacion_sectorial = sum(emp_per_working_age, na.rm = TRUE), .groups = "drop")

 
  umbral <- 0.03
  n_otros <- sum(tb$participacion_sectorial < umbral)

  if (n_otros <= 1) {
    tb <- tb %>% mutate(nace_label_grouped = nace_r2.name)
    texto_otros <- NULL
  } else {
    tb <- tb %>% mutate(
      nace_label_grouped = ifelse(participacion_sectorial < umbral,
                                  "Otros",
                                  nace_r2.name)
    )

    sectores_otros <- tb %>%
      filter(participacion_sectorial < umbral) %>%
      pull(nace_r2.name)

    if (length(sectores_otros) > 2) {
      linea1 <- paste(sectores_otros[1:2], collapse = ", ")
      linea2 <- paste(sectores_otros[3:length(sectores_otros)], collapse = ", ")
      texto_otros <- paste0("Otros: ", linea1, ",<br>", linea2)
    } else {
      texto_otros <- paste0("Otros: ", paste(sectores_otros, collapse = ", "))
    }
  }

 req(nrow(tb) > 0)
  
  tb_plot <- tb %>%
    group_by(nace_label_grouped) %>%
    mutate(
      legend_label = nace_label_grouped,
      participacion_sectorial = participacion_sectorial * 100
    )

  
  if (!is.null(texto_otros) && "Otros" %in% tb_plot$nace_label_grouped) {
    tb_plot$legend_label[tb_plot$nace_label_grouped == "Otros"] <- texto_otros
  }

 
  tb_plot %>%
    plot_ly(labels = ~legend_label, values = ~participacion_sectorial) %>%
    add_pie(
      textinfo = "none",
      hovertemplate = "%{label}: %{percent}<extra></extra>",
      domain = list(x = c(0, 0.65), y = c(0.3, 1.1))
    ) %>%
    layout(
      showlegend = TRUE,
      legend = list(
        orientation = "v",
        x = 0.75,
        xanchor = "left",
        y = 0.65,
        yanchor = "middle",
        itemwidth = 30,
        font = list(size = 14)
      ),
      margin = list(r = 150)
    )
    }
})
)
```


### **Brecha de g√©nero ‚ôÄÔ∏è|‚ôÇÔ∏è**
```{r}
renderPlotly({
if (input$NUTS_a == "‚Äî") {
  if (input$Region_a == "EU27_2020") {
    tb <- TASA_EMPLEO %>% 
      filter(NUTS == 0, EU27_2020 == "SI")
  }
  else if (input$Region_a %in% unique(TASA_EMPLEO$geographic_group)) {
    tb <- TASA_EMPLEO %>% 
      filter(NUTS == 0, geographic_group == input$Region_a)
  }
  else if (input$Region_a == "Canarias") {
    tb <- TASA_EMPLEO %>% 
      filter(NUTS == 2, full_name == input$Region_a)
  }
  else if (input$Region_a %in% Islas_Canarias) {
    tb <- TASA_EMPLEO %>%
      filter(full_name == input$Region_a)
  }
  else {
    tb <- TASA_EMPLEO %>% 
      filter(NUTS == 0, full_name == input$Region_a)
  }
}
else {
  tb <- TASA_EMPLEO %>% 
      filter(NUTS == input$NUTS_a, full_name == input$Region_a)
}
  req(nrow(tb) > 0)
  
  tb_plot <- tb %>%
    filter(
      age %in% c("Y15-24","Y25-34","Y35-44","Y45-54","Y55-64"),
      !is.na(emp_rate),
      sex %in% c("F", "M")
    ) %>%
    group_by(TIME_PERIOD, sex, age) %>%
    summarise(emp_rate_mean = mean(emp_rate, na.rm = TRUE), .groups = "drop") %>%
    mutate(age = factor(age, 
      levels = c("Y15-24","Y25-34","Y35-44","Y45-54","Y55-64")
    ),
    ids = paste0(sex, "_", age)) %>%
    rename(A√±o = TIME_PERIOD)

  plot_ly(
    data = tb_plot,
    x = ~age,
    y = ~emp_rate_mean,
    color = ~sex,
    colors = c("M" = "#1f77b4", "F" = "#e377c2"),
    frame = ~A√±o,
    type = "bar",
    ids = ~ids,
    legendgroup = ~sex,
    name = ~sex,
    hovertemplate = paste0(
  "Edad: %{x}\n",
  "Tasa: ", round(tb_plot$emp_rate_mean,1), "%"
    )
  ) %>%
    layout(
      barmode = "group",
      xaxis = list(
        title = "Grupo de edad",
        categoryorder = "array",
        categoryarray = c("Y15-24","Y25-34","Y35-44","Y45-54","Y55-64"),
        ticktext = c("15-24","25-34","35-44","45-54","55-64"),
        tickvals = c("Y15-24","Y25-34","Y35-44","Y45-54","Y55-64")
      ),
      yaxis = list(
        title = "Tasa de empleo (%)",
        range = c(0, 100)
      ),
      legend = list(title = list(text = "Sexo")),
      uirevision = "legend"
    ) %>%
    animation_opts(
      frame = 200,
      easing = "linear",
      redraw = TRUE
    )
})
```

Time Series
=======================================================================
```{r}
div(
  style = "display: flex; flex-wrap: wrap; gap: 10px; align-items: flex-start; padding: 10px;",
  
  # Contenedor responsivo
  div(
    style = "display: flex; flex-wrap: wrap; gap: 10px; width: 100%;",
    
    # Grupo 1: Indicador, NUTS, Regi√≥n
    div(
      style = "display: flex; flex-wrap: wrap; gap: 10px; flex: 1 1 auto; min-width: 250px;",
      
      div(
        style = "display: flex; flex-direction: column; flex: 1 0 120px;",
        tags$label("Indicador", style = "margin-bottom: 3px; font-size: 0.85em;"),
        selectInput(
          "Indicadort", 
          label = NULL,
          choices = c("NACE Rev. 2", "Sexo/Edad"),
          selected = "NACE Rev. 2",
          width = "100%"
        )
      ),
      
      div(
        style = "display: flex; flex-direction: column; flex: 0 0 80px;",
        tags$label("NUTS", style = "margin-bottom: 3px; font-size: 0.85em;"),
        selectInput(
          "NUTS_x", 
          label = NULL,
          choices = c("‚Äî", unique(EMPLEO$NUTS)) %>%
            na.omit(),
          selected = "‚Äî",
          width = "100%"
        )
      ),
      
      div(
        style = "display: flex; flex-direction: column; flex: 1 0 150px;",
        tags$label("Regi√≥n", style = "margin-bottom: 3px; font-size: 0.85em;"),
        selectInput(
          "Region", 
          label = NULL,
          choices = c("All", "EU27_2020", unique(EMPLEO$geographic_group), "Spain", c("Canarias", "Gran Canaria", "Tenerife", "Fuerteventura", "Lanzarote", "La Gomera", "La Palma", "El Hierro")) %>%
            na.omit(),
          selected = "EU27_2020",
          width = "100%"
        )
      )
    ),
    
    # Grupo 2: Status|Sexo y Sector|Edad
    div(
      style = "display: flex; flex-wrap: wrap; gap: 10px; flex: 2 1 auto; min-width: 300px;",
      
      div(
        style = "display: flex; flex-direction: column; flex: 1 0 120px;",
        tags$label("Status|Sexo", style = "margin-bottom: 3px; font-size: 0.85em;"),
        selectInput(
          "StaSex", 
          label = NULL,
          choices = c(setNames(unique(EMPLEO$wstatus), c("Total", "Asalariados", "Aut√≥nomos")), "Ambos"),
          selected = "EMP",
          width = "100%"
        )
      ),
      
      div(
        style = "display: flex; flex-direction: column; flex: 2 1 200px;",
        tags$label("Sector|Edad", style = "margin-bottom: 3px; font-size: 0.85em;"),
        selectInput(
          "Selec", 
          label = NULL,
          choices = unique(EMPLEO$nace_r2.name),
          selected = c("Agric./Ganad./Pesca", "Industria", "Construcci√≥n", "Comercio/Transporte/Hosteler√≠a/Info-Com", "Adm./Sanid./Educ./Defen.", "Finanzas/Seguros"),
          multiple = TRUE,
          width = "100%"
        )
      ),
      
      div(
        style = "display: flex; align-items: center; justify-content: center; flex: 0 0 auto; padding-top: 20px;",
        checkboxInput(
          "scale_free_y", "Eje Y libre", value = TRUE,
          width = "auto"
        )
      )
    )
  )
)
```


```{r}
observeEvent(input$Indicadort, {
  req(input$Indicadort)
  
  if (input$Indicadort == "NACE Rev. 2") {
    updateSelectInput(
      session = session,
      inputId = "Selec",
      choices = unique(EMPLEO$nace_r2.name),
      selected = c("Agric./Ganad./Pesca", "Industria", "Construcci√≥n", 
                  "Comercio/Transporte/Hosteler√≠a/Info-Com", 
                  "Adm./Sanid./Educ./Defen.", "Finanzas/Seguros")
    )
    updateSelectInput(
      session = session,
      inputId = "StaSex",
      choices = c(setNames(unique(EMPLEO$wstatus), c("Total", "Asalariados", "Aut√≥nomos")), "Ambos"),
      selected = "EMP"
    )
  } else {
    updateSelectInput(
      session = session,
      inputId = "Selec",
      choices = unique(TASA_EMPLEO$age) %>% na.omit(),
      selected = c("Y15-24", "Y25-34", "Y35-44", "Y45-54")
    )
    updateSelectInput(
      session = session,
      inputId = "StaSex",
      choices = c(setNames(unique(TASA_EMPLEO$sex), c("Mujeres", "Hombres", "Total")), "Ambos") %>% na.omit(),
      selected = "T"
    )
  }
  
  # FORZAR ACTUALIZACI√ìN DE REGION cuando cambia el indicador
  current_nuts <- input$NUTS_x
  if (!is.null(current_nuts)) {
    if (current_nuts == "‚Äî") {
      if (input$Indicadort == "NACE Rev. 2") {
        region_choices <- c("All", "EU27_2020",
                           unique(EMPLEO$geographic_group),
                           "Spain",
                           c("Canarias", "Gran Canaria", "Tenerife",
                             "Fuerteventura", "Lanzarote", "La Gomera",
                             "La Palma", "El Hierro")) %>% na.omit()
        selected_region <- "EU27_2020"
      } else {
        region_choices <- c("EU27_2020",
                           unique(EMPLEO$geographic_group),
                           "Spain",
                           c("Canarias", "Gran Canaria", "Tenerife",
                             "Fuerteventura", "Lanzarote", "La Gomera",
                             "La Palma", "El Hierro")) %>% na.omit()
        selected_region <- "EU27_2020"
      }
      updateSelectInput(
        session = session,
        inputId = "Region",
        choices = region_choices,
        selected = selected_region
      )
    }
  }
})

observeEvent(input$NUTS_x, {
  req(input$NUTS_x, input$Indicadort)
  
  if (input$NUTS_x == "‚Äî") {
    if (input$Indicadort == "NACE Rev. 2") {
      region_choices <- c("All", "EU27_2020",
                         unique(EMPLEO$geographic_group),
                         "Spain",
                         c("Canarias", "Gran Canaria", "Tenerife",
                           "Fuerteventura", "Lanzarote", "La Gomera",
                           "La Palma", "El Hierro")) %>% na.omit()
      selected_region <- "EU27_2020"
    } else {
      region_choices <- c("EU27_2020",
                         unique(EMPLEO$geographic_group),
                         "Spain",
                         c("Canarias", "Gran Canaria", "Tenerife",
                           "Fuerteventura", "Lanzarote", "La Gomera",
                           "La Palma", "El Hierro")) %>% na.omit()
      selected_region <- "EU27_2020"
    }
    updateSelectInput(
      session = session,
      inputId = "Region",
      choices = region_choices,
      selected = selected_region
    )
  } else if (input$NUTS_x == "0") {
    updateSelectInput(session, "Region", choices = nuts0[nuts0 != "Norway"] %>% na.omit(), selected = "Spain")
  } else if (input$NUTS_x == "1") {
    updateSelectInput(session, "Region", choices = nuts1 %>% na.omit(), selected = "Centro (ES)")
  } else if (input$NUTS_x == "2") {
    updateSelectInput(session, "Region", choices = nuts2 %>% na.omit(), selected = "Canarias")
  } else {
    updateSelectInput(session, "Region", choices = nuts3 %>% na.omit(), selected = "Gran Canaria")
  }
})

# Observer para cuando Region cambia DE "All" a otra cosa
observeEvent(input$Region, {
  req(input$Region, input$Indicadort)
  
  if (input$Region != "All" && input$Indicadort == "NACE Rev. 2") {
    updateSelectInput(
      session = session,
      inputId = "StaSex",
      choices = c(setNames(unique(EMPLEO$wstatus), c("Total", "Asalariados", "Aut√≥nomos")), "Ambos"),
      selected = ifelse(input$StaSex %in% unique(EMPLEO$wstatus), input$StaSex, "EMP")
    )
  }
})

# Observer para cuando Region es "All" - quitar Ambos SOLO para NACE Rev. 2
observeEvent(list(input$Region, input$Indicadort), {
  req(input$Region, input$Indicadort)
  
  if (input$Region == "All" && input$Indicadort == "NACE Rev. 2") {
    updateSelectInput(
      session = session,
      inputId = "StaSex",
      choices = setNames(unique(EMPLEO$wstatus), c("Total", "Asalariados", "Aut√≥nomos")),
      selected = "EMP"
    )
  }
})
```


Column {.tabset}
--------------------------------------------------

### Time Series one by one

```{r}
inputs.processing.series_one_by_one <- reactive({
if (input$Indicadort == "NACE Rev. 2") {
  if (input$NUTS_x == "‚Äî") {
  if (input$Region == "EU27_2020") {
    tb <- EMPLEO %>% 
      filter(NUTS == 0, EU27_2020 == "SI", nace_r2.name %in% input$Selec)
  }
  else if (input$Region %in% unique(EMPLEO$geographic_group)) {
    tb <- EMPLEO %>% 
      filter(NUTS == 0, geographic_group == input$Region, nace_r2.name %in% input$Selec)
  }
  else if (input$Region == "Canarias") {
    tb <- EMPLEO %>% 
      filter(NUTS == 2, full_name == input$Region, nace_r2.name %in% input$Selec)
  }
  else {
    tb <- EMPLEO %>%
      filter(full_name == input$Region, nace_r2.name %in% input$Selec)
  }
}
  else {
    tb <- EMPLEO %>% 
      filter(NUTS == input$NUTS_x, full_name == input$Region, nace_r2.name %in% input$Selec)
  }
  
  if (input$StaSex == "Ambos") {
      tb <- tb %>% filter(wstatus != "EMP")
  }
  else {
      tb <- tb %>% filter(wstatus == input$StaSex)
  }
}
else {
if (input$NUTS_x == "‚Äî") {
  if (input$Region == "EU27_2020") {
    tb <- TASA_EMPLEO %>% 
      filter(NUTS == 0, EU27_2020 == "SI", age %in% input$Selec)
  }
  else if (input$Region %in% unique(TASA_EMPLEO$geographic_group)) {
    tb <- TASA_EMPLEO %>% 
      filter(NUTS == 0, geographic_group == input$Region, age %in% input$Selec)
  }
  else if (input$Region == "Canarias") {
    tb <- TASA_EMPLEO %>% 
      filter(NUTS == 2, full_name == input$Region, age %in% input$Selec)
  }
  else {
    tb <- TASA_EMPLEO %>% 
      filter(full_name == input$Region, age %in% input$Selec)
  }
}
  else {
    tb <- TASA_EMPLEO %>% 
      filter(NUTS == input$NUTS_x, full_name == input$Region, age %in% input$Selec)
  }
  
  if (input$StaSex == "Ambos") {
      tb <- tb %>% filter(sex != "T")
  }
  else {
      tb <- tb %>% filter(sex == input$StaSex)
  }
  
}
  return(tb)
})
```

```{r}
renderPlotly({
  req(input$Selec[1])
  scale_y <- ifelse(input$scale_free_y == TRUE, "free_y", "fixed")
  
  if (input$Region == "All") {
  
  # Base filtrada
  tb_base <- EMPLEO %>% filter(nace_r2.name %in% input$Selec)
  if(input$StaSex != "Ambos") tb_base <- tb_base %>% filter(wstatus == input$StaSex)
  
  # Lista para almacenar todos los datos
  list_tb <- list()
  
  # 1. EU27_2020
  eu27 <- tb_base %>%
    filter(EU27_2020 == "SI", NUTS == 0, TIME_PERIOD <= 2022) %>%
    group_by(TIME_PERIOD, nace_r2.name) %>%
    summarise(
      employment = sum(employment, na.rm = TRUE),
      working_age_population = sum(working_age_population, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(emp_per_working_age = 100 * (employment * 1000 / working_age_population),
           Region = "EU27_2020")
  list_tb[["EU27_2020"]] <- eu27
  
  # 2. Espa√±a
  spain <- tb_base %>%
    filter(full_name == "Spain", TIME_PERIOD <= 2022) %>%
    group_by(TIME_PERIOD, nace_r2.name) %>%
    summarise(
      employment = sum(employment, na.rm = TRUE),
      working_age_population = sum(working_age_population, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(emp_per_working_age = 100 * (employment * 1000 / working_age_population),
           Region = "Spain")
  list_tb[["Spain"]] <- spain
  
  # 3. Canarias y sus islas
  canarias_islas <- c("Canarias", "Gran Canaria", "Tenerife")
  
  canarias_data <- tb_base %>%
    filter(full_name %in% canarias_islas | (full_name == "Canarias" & NUTS == 2), TIME_PERIOD <= 2022) %>%
    group_by(TIME_PERIOD, nace_r2.name, full_name) %>%
    summarise(
      employment = sum(employment, na.rm = TRUE),
      working_age_population = sum(working_age_population, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(emp_per_working_age = 100 * (employment * 1000 / working_age_population),
           Region = full_name) %>%
    select(-full_name)
  
  # Agregar cada isla individualmente
  for(isla in unique(canarias_data$Region)) {
    list_tb[[isla]] <- canarias_data %>% filter(Region == isla)
  }
  
  # 4. Grupos geogr√°ficos
  grupos_geograficos <- c("NORTH", "SOUTH", "EST", "WEST")
  
  for(grupo in grupos_geograficos) {
    grupo_data <- tb_base %>%
      filter(geographic_group == grupo, NUTS == 0, TIME_PERIOD <= 2022) %>%
      group_by(TIME_PERIOD, nace_r2.name) %>%
      summarise(
        employment = sum(employment, na.rm = TRUE),
        working_age_population = sum(working_age_population, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      mutate(emp_per_working_age = 100 * (employment * 1000 / working_age_population),
             Region = grupo)
    list_tb[[grupo]] <- grupo_data
  }
  
  # Combinar todo
  tb <- bind_rows(list_tb) %>%
  mutate(emp_per_working_age = round(emp_per_working_age, 2),
         Region = factor(Region, levels = c("Gran Canaria", "Tenerife", "Canarias", "Spain", 
                                           "NORTH", "SOUTH", "EST", "WEST", "EU27_2020")))
  
  # Preparar para ggplot y autoplot
  tb_plot <- tb %>%
    rename(Sector = nace_r2.name, 
           A√±o = TIME_PERIOD,
           `Tasa de empleo` = emp_per_working_age)
  
  # Crear tsibble y usar autoplot
  tb_ts <- tb_plot %>%
    as_tsibble(key = c(Sector, Region), index = A√±o)
  
  tb_p <- autoplot(tb_ts, `Tasa de empleo`) +
    aes(colour = Sector) +
    facet_wrap(~Region, scales = scale_y, nrow = 3) +
    theme_bw(base_size = 14) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
      axis.text.y = element_text(size = 10),
      strip.text = element_text(size = 8, margin = margin(2, 0, 2, 0)),
      panel.spacing.x = unit(0.05, "lines"),
      legend.position = "none"
    ) +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
    scale_y_continuous(labels = scales::percent_format(scale = 1)) +
    labs(x = NULL, y = NULL)
  
  ggplotly(tb_p) %>%
  layout(
    autosize = TRUE,
    margin = list(l = 60, r = 30, b = 100, t = 20),
    font = list(size = 10)
  ) %>%
  style(hoverlabel = list(font = list(size = 12))) %>%
  config(
    displayModeBar = FALSE,
    responsive = TRUE
  )
  }
  
  else {
    tb <- inputs.processing.series_one_by_one()
  
  req(nrow(tb) > 0)
  
  if (input$Indicadort == "NACE Rev. 2") {
  tb <- tb %>% filter(TIME_PERIOD <= 2022)
  
  req(input$Selec[1])
  
  if (input$StaSex != "Ambos") {
  
  if (input$Region == "EU27_2020") {
    tb <- tb %>% 
      group_by(TIME_PERIOD, nace_r2.name) %>%
      summarise(employment = sum(employment, na.rm = TRUE),
                working_age_population = sum(working_age_population, na.rm = TRUE)) %>%
      mutate(emp_per_working_age = 100*(employment*1000/working_age_population))
  }
  else if (input$Region %in% unique(EMPLEO$geographic_group)) {
    tb <- tb %>% 
      group_by(TIME_PERIOD, nace_r2.name) %>%
      summarise(employment = sum(employment, na.rm = TRUE),
                working_age_population = sum(working_age_population, na.rm = TRUE)) %>%
      mutate(emp_per_working_age = 100*(employment*1000/working_age_population))
  }
  else {
    tb <- tb %>% 
      mutate(emp_per_working_age = emp_per_working_age * 100)
  }
  }
  else {
  if (input$Region == "EU27_2020") {
    tb <- tb %>% 
      group_by(TIME_PERIOD, nace_r2.name, wstatus) %>%
      summarise(employment = sum(employment, na.rm = TRUE),
                working_age_population = sum(working_age_population, na.rm = TRUE)) %>%
      mutate(emp_per_working_age = 100*(employment*1000/working_age_population))
  }
  else if (input$Region %in% unique(EMPLEO$geographic_group)) {
    tb <- tb %>% 
      group_by(TIME_PERIOD, nace_r2.name, wstatus) %>%
      summarise(employment = sum(employment, na.rm = TRUE),
                working_age_population = sum(working_age_population, na.rm = TRUE)) %>%
      mutate(emp_per_working_age = 100*(employment*1000/working_age_population))
  }
  else {
    tb <- tb %>% 
      mutate(emp_per_working_age = emp_per_working_age * 100)
  }
  }
  
  if (input$StaSex != "Ambos") {
  tb_plot <- tb %>% 
    rename(Sector = nace_r2.name, A√±o = TIME_PERIOD, `Tasa de empleo en edad de trabajar` =  emp_per_working_age) %>%
    mutate(`Tasa de empleo en edad de trabajar` = round(`Tasa de empleo en edad de trabajar`, 2))
  
  tb_p <- tb_plot %>%
    as_tsibble(key = Sector, index = A√±o) %>%
    autoplot(`Tasa de empleo en edad de trabajar`, aes(color = Sector, group = 1)) +
    facet_wrap(~Sector, scales =  scale_y, nrow = 3) +
    theme_bw(base_size = 14) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
      strip.text = element_text(size = 8, margin = margin(2, 0, 2, 0)),
      panel.spacing.x = unit(0.1, "lines"),
      panel.spacing.y = unit(0.6, "lines"),
      axis.title.y = element_blank(),
      axis.text.y  = element_text(size = 8),
      axis.ticks.y = element_blank(),
      plot.margin = margin(5, 5, 5, 5),
      legend.position = "none"
    ) +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
    scale_y_continuous(labels = scales::percent_format(scale = 1)) +
    labs(x = NULL, y = NULL)
  }
  
  else{
    tb_plot <- tb %>% 
    rename(Sector = nace_r2.name, A√±o = TIME_PERIOD, `Tasa de empleo en edad de trabajar` =  emp_per_working_age) %>%
    mutate(`Tasa de empleo en edad de trabajar` = round(`Tasa de empleo en edad de trabajar`, 2)) %>%
    mutate(
    wstatus = recode(wstatus,
      "SAL"  = "Asalariados",
      "SELF" = "Aut√≥nomos"
    )
    )
  
  tb_p <- tb_plot %>%
    as_tsibble(key = c(Sector, wstatus), index = A√±o) %>%
    autoplot(`Tasa de empleo en edad de trabajar`, aes(color = wstatus, group = wstatus, text = paste(
      "<b>A√±o:</b>", A√±o,
      "<br><b>Tasa:</b>", `Tasa de empleo en edad de trabajar`, "%",
      "<br><b>Sector:</b>", Sector,
      "<br>Status<b>:</b>", wstatus))
    ) +
    facet_wrap(~Sector, scales =  scale_y , nrow = 3) +
    theme_bw(base_size = 14) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
      strip.text = element_text(size = 8, margin = margin(2, 0, 2, 0)),
      panel.spacing.x = unit(0.1, "lines"),
      panel.spacing.y = unit(0.6, "lines"),
      axis.title.y = element_blank(),
      axis.text.y  = element_text(size = 8),
      axis.ticks.y = element_blank(),
      plot.margin = margin(5, 5, 5, 5),
      legend.position = "bottom"
    ) +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
    scale_y_continuous(labels = scales::percent_format(scale = 1)) +
    scale_color_manual(values = c(
  "Asalariados" = "#1f77b4",  
  "Aut√≥nomos"   = "#8c564b" 
)) +
    labs(x = NULL, y = NULL)
  }
  
  if (input$StaSex != "Ambos") {
  ggplotly(tb_p) %>%
  layout(
    autosize = TRUE,
    margin = list(l = 60, r = 30, b = 100, t = 20),
    font = list(size = 10)
  ) %>%
  style(hoverlabel = list(font = list(size = 12))) %>%
  config(
    displayModeBar = FALSE,
    responsive = TRUE
  )

  }
  else {
    ggplotly(tb_p, tooltip = "text") %>%
  layout(
    legend = list(
        title = list(text = NULL),
        orientation = "h",
        x = 0.5,
        xanchor = "center",
        y = -0.18,
        yanchor = "top"
      ),
    autosize = TRUE,
    margin = list(l = 60, r = 30, b = 120, t = 20),
    font = list(size = 10)
  ) %>%
  style(hoverlabel = list(font = list(size = 12))) %>%
  config(
    displayModeBar = FALSE,
    responsive = TRUE
  )
  }
}
else {
  req(input$Selec[1])
  
  if (input$StaSex != "Ambos") {
  
  if (input$Region == "EU27_2020") {
    tb <- tb %>% 
      group_by(TIME_PERIOD, age) %>%
      summarise(tasa_emp = mean(emp_rate, na.rm = TRUE))
  }
  else if (input$Region %in% unique(TASA_EMPLEO$geographic_group)) {
    tb <- tb %>% 
      group_by(TIME_PERIOD, age) %>%
      summarise(tasa_emp = mean(emp_rate, na.rm = TRUE))
  }
    else{
      tb <- tb %>%
        rename(tasa_emp = emp_rate)
    }
  }
  else {
  if (input$Region == "EU27_2020") {
    tb <- tb %>% 
      group_by(TIME_PERIOD, age, sex) %>%
      summarise(tasa_emp = mean(emp_rate, na.rm = TRUE))
  }
  else if (input$Region %in% unique(TASA_EMPLEO$geographic_group)) {
    tb <- tb %>% 
      group_by(TIME_PERIOD, age, sex) %>%
      summarise(tasa_emp = mean(emp_rate, na.rm = TRUE))
  }
    else {
      tb <- tb %>%
        rename(tasa_emp = emp_rate)
    }
  }
  
  if (input$StaSex != "Ambos") {
  tb_plot <- tb %>% 
    rename(Edad = age, A√±o = TIME_PERIOD, `Tasa de empleo` =  tasa_emp) %>%
    mutate(`Tasa de empleo` = round(`Tasa de empleo`, 2))
  
  tb_p <- tb_plot %>%
    as_tsibble(key = Edad, index = A√±o) %>%
    autoplot(`Tasa de empleo`, aes(color = Edad, group = 1)) +
    facet_wrap(~Edad, scales =  scale_y , nrow = 3) +
    theme_bw(base_size = 14) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
      axis.text.y = element_text(size = 10),
      strip.text = element_text(size = 12, margin = margin(2, 0, 2, 0)),
      panel.spacing = unit(0.05, "lines"),
      legend.position = "none"
    ) +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
    scale_y_continuous(labels = scales::percent_format(scale = 1)) +
    labs(x = NULL, y = NULL)
  }
  
  else{
    tb_plot <- tb %>% 
    rename(Edad = age, A√±o = TIME_PERIOD, `Tasa de empleo` =  tasa_emp) %>%
    mutate(`Tasa de empleo` = round(`Tasa de empleo`, 2)) %>%
    mutate(
    sex = recode(sex,
      "M"  = "Hombres",
      "F" = "Mujeres"
    )
    )
  
  tb_p <- tb_plot %>%
    as_tsibble(key = c(Edad, sex), index = A√±o) %>%
    autoplot(`Tasa de empleo`, aes(color = sex, group = sex, text = paste(
      "<b>A√±o:</b>", A√±o,
      "<br><b>Tasa:</b>", `Tasa de empleo`, "%",
      "<br><b>Edad:</b>", Edad,
      "<br>Sexo<b>:</b>", sex))
    ) +
    facet_wrap(~Edad, scales =  scale_y , nrow = 3) +
    theme_bw(base_size = 12) +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
      axis.text.y = element_text(size = 10),
      strip.text = element_text(size = 12, margin = margin(2, 0, 2, 0)),
      panel.spacing = unit(0.05, "lines"),
      legend.position = "none"
    ) +
    scale_x_continuous(breaks = scales::pretty_breaks(n = 6)) +
    scale_y_continuous(labels = scales::percent_format(scale = 1)) +
    scale_color_manual(values = c(
  "Hombres" = "#87CEEB",
  "Mujeres"   = "#FFB6C1" 
)) +
    labs(x = NULL, y = NULL)
  }
  
  if (input$StaSex != "Ambos") {
  ggplotly(tb_p, tooltip = "text") %>%
  layout(
    autosize = TRUE,
    margin = list(l = 60, r = 30, b = 100, t = 20),
    font = list(size = 10)
  ) %>%
  style(hoverlabel = list(font = list(size = 12))) %>%
  config(
    displayModeBar = FALSE,
    responsive = TRUE
  )

    }
  else {
    ggplotly(tb_p, tooltip = "text") %>%
  layout(
    autosize = TRUE,
    margin = list(l = 60, r = 30, b = 100, t = 20),
    font = list(size = 10)
  ) %>%
  style(hoverlabel = list(font = list(size = 12))) %>%
  config(
    displayModeBar = FALSE,
    responsive = TRUE
  )

  }
}  
}
})
```

### Time Series all together 

```{r}
inputs.processing.series_all_together <- reactive({
  if (input$Indicadort == "NACE Rev. 2") {
    if (input$NUTS_x == "‚Äî") {
    
    if (input$Region == "EU27_2020") {
    tb <- EMPLEO %>% 
      filter(NUTS == 0, EU27_2020 == "SI")
  }
  else if (input$Region %in% unique(EMPLEO$geographic_group)) {
    tb <- EMPLEO %>% 
      filter(NUTS == 0, geographic_group == input$Region)
  }
  else if (input$Region == "Canarias") {
    tb <- EMPLEO %>% 
      filter(NUTS == 2, full_name == input$Region)
  }
  else {
    tb <- EMPLEO %>%
      filter(full_name == input$Region)
  }
}
  else {
    tb <- EMPLEO %>% 
      filter(NUTS == input$NUTS_x, full_name == input$Region)
  }
  
  if (input$StaSex == "Ambos") {
    tb <- tb %>%
      filter(wstatus == "EMP")
  }
  else {
    tb <- tb %>%
      filter(wstatus == input$StaSex)
  }
  }
  else {
    if (input$NUTS_x == "‚Äî") {
    if (input$Region == "EU27_2020") {
    tb <- TASA_EMPLEO %>% 
      filter(NUTS == 0, EU27_2020 == "SI")
  }
  else if (input$Region %in% unique(TASA_EMPLEO$geographic_group)) {
    tb <- TASA_EMPLEO %>% 
      filter(NUTS == 0, geographic_group == input$Region)
  }
  else if (input$Region == "Canarias") {
    tb <- TASA_EMPLEO %>% 
      filter(NUTS == 2, full_name == input$Region)
  }
   else {
      tb <- TASA_EMPLEO %>% 
      filter(full_name == input$Region)
   }
}
  else {
    tb <- TASA_EMPLEO %>% 
      filter(NUTS == input$NUTS_x, full_name == input$Region)
  }
  
  if (input$StaSex == "Ambos") {
    tb <- tb %>% 
      filter(sex == "T")
  } else {
    tb <- tb %>% 
      filter(sex == input$StaSex)
  }
  }
  return(tb)
})
```



```{r}
renderHighchart({
  
  
   if (input$Region == "All") {
  # Crear la tabla como antes
  
  tb_base <- EMPLEO %>% filter(nace_r2.name %in% input$Selec)
  if(input$StaSex != "Ambos") tb_base <- tb_base %>% filter(wstatus == input$StaSex)
  
 
    # NUEVO C√ìDIGO PARA "All" - Calcular todas las regiones como antes
    list_tb <- list()
    
    # 1. EU27_2020
    eu27 <- tb_base %>%
      filter(EU27_2020 == "SI", NUTS == 0, TIME_PERIOD <= 2022) %>%
      group_by(TIME_PERIOD, nace_r2.name) %>%
      summarise(
        employment = sum(employment, na.rm = TRUE),
        working_age_population = sum(working_age_population, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      mutate(emp_per_working_age = (employment * 1000 / working_age_population),
             Region = "EU27_2020")
    list_tb[["EU27_2020"]] <- eu27
    
    # 2. Espa√±a
    spain <- tb_base %>%
      filter(full_name == "Spain", TIME_PERIOD <= 2022) %>%
      group_by(TIME_PERIOD, nace_r2.name) %>%
      summarise(
        employment = sum(employment, na.rm = TRUE),
        working_age_population = sum(working_age_population, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      mutate(emp_per_working_age = (employment * 1000 / working_age_population),
             Region = "Spain")
    list_tb[["Spain"]] <- spain
    
    # 3. Canarias y sus islas
    canarias_islas <- c("Canarias", "Gran Canaria", "Tenerife")
    
    canarias_data <- tb_base %>%
      filter(full_name %in% canarias_islas | (full_name == "Canarias" & NUTS == 2), TIME_PERIOD <= 2022) %>%
      group_by(TIME_PERIOD, nace_r2.name, full_name) %>%
      summarise(
        employment = sum(employment, na.rm = TRUE),
        working_age_population = sum(working_age_population, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      mutate(emp_per_working_age = (employment * 1000 / working_age_population),
             Region = full_name) %>%
      select(-full_name)
    
    for(isla in unique(canarias_data$Region)) {
      list_tb[[isla]] <- canarias_data %>% filter(Region == isla)
    }
    
    # 4. Grupos geogr√°ficos
    grupos_geograficos <- c("NORTH", "SOUTH", "EST", "WEST")
    
    for(grupo in grupos_geograficos) {
      grupo_data <- tb_base %>%
        filter(geographic_group == grupo, NUTS == 0, TIME_PERIOD <= 2022) %>%
        group_by(TIME_PERIOD, nace_r2.name) %>%
        summarise(
          employment = sum(employment, na.rm = TRUE),
          working_age_population = sum(working_age_population, na.rm = TRUE),
          .groups = "drop"
        ) %>%
        mutate(emp_per_working_age = (employment * 1000 / working_age_population),
               Region = grupo)
      list_tb[[grupo]] <- grupo_data
    }
    
    # Combinar todo y filtrar por el primer sector
    tb <- bind_rows(list_tb) %>%
      filter(nace_r2.name == input$Selec[1]) %>%
      as_tsibble(key = Region, index = TIME_PERIOD)
    
    tb_plot <- tb %>% 
      rename(Sector = nace_r2.name,
             A√±o = TIME_PERIOD, 
             `Tasa de empleo en edad de trabajar` = emp_per_working_age) %>%
      filter(Sector != "Total actividades")
    
    hchart(
      tb_plot,
      type = "spline",
      hcaes(
        x = A√±o,
        y = `Tasa de empleo en edad de trabajar`,
        group = Region
      )
    ) %>%
      hc_yAxis(title = list(text = paste("Valor per c√°pita -", input$Selec[1]), style = list(fontWeight = "bold"))) %>%
      hc_xAxis(title = list(text = "A√±o", style = list(fontWeight = "bold"))) %>%
      hc_tooltip(pointFormat = "{series.name}: <b>{point.y:.3f}</b>") %>%
      hc_legend(enabled = TRUE) %>%
      hc_chart(backgroundColor = "white") %>%
      hc_exporting(enabled = TRUE,
        buttons = list(
          contextButton = list(
            menuItems = c("viewFullscreen", "resetZoom")
          )
        )
      )
   }
  
  else {
    tb <- inputs.processing.series_all_together()
if (input$Indicadort == "NACE Rev. 2"){
  tb <-  tb %>% 
    filter(TIME_PERIOD <= 2022)
  
  if (input$Region == "EU27_2020") {
    tb <- tb %>% 
      group_by(TIME_PERIOD, nace_r2.name) %>%
      summarise(employment = sum(employment, na.rm = TRUE),
                working_age_population = sum(working_age_population, na.rm = TRUE)) %>%
      mutate(emp_per_working_age = (employment*1000/working_age_population)) %>%
      as_tsibble(key = nace_r2.name, index = TIME_PERIOD)
  }
  else if (input$Region %in% unique(EMPLEO$geographic_group)) {
    tb <- tb %>% 
      group_by(TIME_PERIOD, nace_r2.name) %>%
      summarise(employment = sum(employment, na.rm = TRUE),
                working_age_population = sum(working_age_population, na.rm = TRUE)) %>%
      mutate(emp_per_working_age = (employment*1000/working_age_population)) %>%
      as_tsibble(key = nace_r2.name, index = TIME_PERIOD)
  }
  else {
    tb <- tb %>% 
      as_tsibble(key = nace_r2.name, index = TIME_PERIOD)
  }
  
  tb_plot <- tb %>% 
    rename(Sector = nace_r2.name) %>%
    filter(Sector != "Total actividades") %>%
    rename(A√±o = TIME_PERIOD, `Tasa de empleo en edad de trabajar` =  emp_per_working_age)
  
  tb_p <- tb_plot %>%
    as_tsibble(key = Sector, index = A√±o)
  
   hchart(
    tb_p,
    type = "spline",
    hcaes(
      x = A√±o,
      y = `Tasa de empleo en edad de trabajar`,
      group = Sector
    )
  ) %>%
    hc_yAxis(title = list(text = "Valor per c√°pita", style = list(fontWeight = "bold"))) %>%
    hc_xAxis(title = list(text = "A√±o", style = list(fontWeight = "bold"))) %>%
    hc_tooltip(pointFormat = "{series.name}: <b>{point.y:.3f}</b>") %>%
    hc_legend(enabled = TRUE) %>%
    hc_chart(backgroundColor = "white") %>%
    hc_exporting(enabled = TRUE,
      buttons = list(
        contextButton = list(
          menuItems = c("viewFullscreen", "resetZoom")
      )
    )
  )
}
  else {
  if (input$Region == "EU27_2020") {
    tb <- tb %>% 
      group_by(TIME_PERIOD, age) %>%
      summarise(tasa_emp = mean(emp_rate, na.rm = TRUE)) %>%
      as_tsibble(key = age, index = TIME_PERIOD)
  }
  else if (input$Region %in% unique(TASA_EMPLEO$geographic_group)) {
    tb <- tb %>% 
      group_by(TIME_PERIOD, age) %>%
      summarise(tasa_emp = mean(emp_rate, na.rm = TRUE)) %>%
      as_tsibble(key = age, index = TIME_PERIOD)
  }
  else {
    tb <- tb %>% 
      rename(tasa_emp = emp_rate) %>%
      as_tsibble(key = age, index = TIME_PERIOD)
  }
  
  tb_plot <- tb %>% 
    rename(Edad = age) %>%
    rename(A√±o = TIME_PERIOD, `Tasa de empleo` =  tasa_emp)
  
  tb_p <- tb_plot %>%
    as_tsibble(key = Edad, index = A√±o)
  
   hchart(
    tb_p,
    type = "spline",
    hcaes(
      x = A√±o,
      y = `Tasa de empleo`,
      group = Edad
    )
  ) %>%
    hc_yAxis(title = list(text = "Porcentaje de empleo", style = list(fontWeight = "bold"))) %>%
    hc_xAxis(title = list(text = "A√±o", style = list(fontWeight = "bold"))) %>%
    hc_tooltip(pointFormat = "{series.name}: <b>{point.y:.2f}%</b>") %>%
    hc_legend(enabled = TRUE) %>%
    hc_chart(backgroundColor = "white") %>%
    hc_exporting(enabled = TRUE,
      buttons = list(
        contextButton = list(
          menuItems = c("viewFullscreen", "resetZoom")
      )
    )
  )
  }
    
  }
})
```



EuroMaps
=================================

```{r}
inputs.processing.empleo_region <- reactive({
  geoj.tb <- geoj[[as.numeric(input$NUTS)+1]] %>% 
  as_tibble()
  
  tb <- geoj.tb %>% 
    left_join(
      EMPLEO %>%
      filter(NUTS == input$NUTS, TIME_PERIOD == input$A√±o, wstatus == "EMP", nace_r2 == "TOTAL"),
      join_by("NUTS_ID" == "geo")
    )
  
  return(tb)
})


inputs.processing.tasa_empleo_gender <- reactive({
  geoj.tb <- geoj[[as.numeric(input$NUTS_b)+1]] %>% 
    as_tibble()
  
  tb <- geoj.tb %>% 
    left_join(
      GENDER_GAP %>%
      filter(NUTS == input$NUTS_b, TIME_PERIOD == input$A√±o_b, age == input$Edad),
      join_by("NUTS_ID" == "geo")
    )
  
  return(tb)
})


inputs.processing.key_indicator <- reactive({
  geoj.tb <- geoj[[1]] %>% 
    as_tibble()
  
  tb <- geoj.tb %>% 
    left_join(
      KEY_INDICATORS %>%
      filter(Year == input$A√±o_c, nchar(geo) == 2),
      join_by("NUTS_ID" == "geo")
    )
  
  return(tb)
})
```


```{r}
tabla_empleo_regiones <- DT::renderDataTable({
  
  req(input$NUTS, input$A√±o)
  tb <- inputs.processing.empleo_region()
  req(nrow(tb) > 0) 
  
  tb <- tb %>%
    arrange(desc(employment)) %>%
    select(Regi√≥n = full_name, Valor = employment) %>%
    na.omit() %>%
    mutate(Valor = Valor * 1000)

  DT::datatable(
    tb %>% mutate(Valor = prettyNum(round(Valor,0), big.mark = ".")),
    options = list(
    paging = FALSE,
    scrollCollapse = TRUE,
    autoWidth = FALSE
    ),
    fillContainer = TRUE,
    callback = JS("table.draw();")
  )
})


tabla_empleo_sexo_edad <- DT::renderDataTable({
  
  req(input$NUTS_b, input$A√±o_b, input$Edad)
  tb <- inputs.processing.tasa_empleo_gender()
  req(nrow(tb) > 0) 
  
  tb <- tb %>%
   arrange(desc(!!sym(input$Indicador)))%>%  
   select(Regi√≥n = full_name, Valor = !!sym(input$Indicador)) %>%
   na.omit()
  
  DT::datatable(
    tb %>% mutate(Valor=prettyNum(
  round(Valor,
   digits=max(5-nchar(as.character(round(max(na.omit(Valor))))),0)
  ),
  big.mark = ".")
  ),
    options = list(
    paging = FALSE,
    scrollCollapse = TRUE,
    autoWidth = FALSE
    ),
    fillContainer = TRUE,
    callback = JS("table.draw();")
  )
})

tabla_key_indicators <- DT::renderDataTable({
  req(input$Indicador_Key, input$A√±o_c)
  
  # Filtramos pa√≠ses disponibles
  PAISES <- EMPLEO %>% 
    filter(nace_r2 == "TOTAL", wstatus == "EMP", NUTS == 0)
  
  # Tabla base
  tb <- inputs.processing.key_indicator() %>%
    filter(NUTS_ID %in% as.character(unique(PAISES$geo))) %>%
    arrange(desc(!!sym(input$Indicador_Key))) %>%
    select(Pa√≠s = Country, Valor = !!sym(input$Indicador_Key), NUTS_ID) %>%
    filter(!is.na(Valor))  # solo eliminar filas sin indicador
  
  # A√±adimos tasa de empleo (si hay datos)
  emp_tb <- EMPLEO %>%
    filter(
      TIME_PERIOD == input$A√±o_c,
      nace_r2 == "TOTAL",
      wstatus == "EMP",
      NUTS == 0
    ) %>%
    select(geo, emp_per_working_age) %>%
    mutate(geo = as.character(geo))  # asegurar tipo character
  
  tb <- tb %>%
    left_join(emp_tb, by = c("NUTS_ID" = "geo"))
  
  DT::datatable(
    tb %>%
      mutate(
        Valor = prettyNum(round(Valor,
                                digits = max(5 - nchar(as.character(round(max(Valor, na.rm = TRUE)))), 0)),
                         big.mark = ","),
        `Tasa de empleo` = ifelse(is.na(emp_per_working_age), "", paste0(round(emp_per_working_age*100,2), "%"))
      ) %>%
      select(Pa√≠s, Valor, `Tasa de empleo`),
    options = list(
      paging = FALSE,
      scrollCollapse = TRUE,
      autoWidth = FALSE,
      rownames = FALSE
    ),
    rownames = FALSE,
    fillContainer = TRUE,
    callback = JS("table.draw();")
  )
})
```

```{r}
mapa_empleo_regiones <- leaflet::renderLeaflet({
  # capturamos el resultado del procesado de los inputs 
  tb <- inputs.processing.empleo_region() %>%
    left_join(coord[[as.numeric(input$NUTS)+1]], by = c("full_name" = "Region")) %>%
    drop_na(employment, Latitude, Longitude)
  
  pal <- colorNumeric(
    palette = "YlGnBu",
    domain = tb$employment
  )
  
  etiquetas <- paste(
    "<strong> ", tb$full_name,
    ": ",prettyNum(round(tb$employment*1000,
    digits=max(5-nchar(as.character(round(max(na.omit(tb$employment*1000))))),0)
    ),
    big.mark = ".")
    ) %>%
    lapply(htmltools::HTML)
  
  make_svg_icon <- function(color) {
    svg <- paste0(
      '<svg width="32" height="48" viewBox="0 0 32 48" xmlns="http://www.w3.org/2000/svg">
          <path fill="', color,'" stroke="black" stroke-width="2"
          d="M16 0C8 0 2 6 2 14c0 10 14 28 14 28s14-18 14-28C30 6 24 0 16 0z"/>
          <circle cx="16" cy="14" r="6" fill="white"/>
        </svg>'
    )
    
    leaflet::makeIcon(
      iconUrl = paste0("data:image/svg+xml;base64,", base64enc::base64encode(charToRaw(svg))),
      iconWidth = 32, iconHeight = 48, iconAnchorX = 16, iconAnchorY = 48
    )
  }

  icons <- lapply(pal(tb$employment), make_svg_icon)
  icons <- do.call(iconList, icons)
  
  if(as.numeric(input$NUTS) == 0 || as.numeric(input$NUTS) == 1) {
    geoj[[as.numeric(input$NUTS)+1]] %>% 
      leaflet() %>%
      addTiles() %>% 
      addCircles(
        lng = tb$Longitude, 
        lat = tb$Latitude, 
        weight = 1, 
        color = "black",
        radius = sqrt(tb$emp_per_working_age*100)*1e4, 
        fillOpacity = 0.7,
        fillColor = pal(tb$employment), 
        label = etiquetas 
        ) %>% 
        addLegend(
          pal = pal,
          values = tb$employment,
          title = "Miles de empleados"
      )
  } else {
    geoj[[as.numeric(input$NUTS)+1]] %>% 
      leaflet() %>%
      addTiles() %>% 
      addMarkers(
        lng = tb$Longitude, 
        lat = tb$Latitude, 
        label= etiquetas,
        icon = icons, 
        clusterOptions = markerClusterOptions() 
      ) %>%
        addLegend(
          pal = pal,
          values = tb$employment,
          title = "Miles de empleados"
        )
  }
}) %>%
  bindCache(input$NUTS, input$A√±o)

mapa_empleo_sexo_edad <- leaflet::renderLeaflet({
 # capturamos el resultado del procesado de los inputs 
 tb <- inputs.processing.tasa_empleo_gender()
 
 paleta <- switch(
    input$Indicador,
    "F" = colorRampPalette(c("#FCD6E5", "#C77BFF")),
    "M" = colorRampPalette(c("#cfe2ff", "#0031a0")),
    "T" = NULL,   
    "gender_gap" = colorRampPalette(c("#B2182B", "#FFFFFF", "#2166AC"))
  )

valores <- tb[[input$Indicador]]

valores_txt <- ifelse(
  is.na(valores),
  "Sin datos",
  prettyNum(round(valores, 2), big.mark = ",", scientific = FALSE)
)

etiquetas <- paste0(
  "<strong>", tb$full_name, "</strong><br>",
  paste0(input$Indicador, "/", input$Edad), ": ", valores_txt
) %>% lapply(htmltools::HTML)

 # dibujamos el mapa 
 MapaCoropl√©tico(geoj[[as.numeric(input$NUTS_b)+1]], tb[[input$Indicador]], etiquetas, ifelse(input$Indicador == "gender_gap", "Brecha de g√©nero", "% de empleo"), palette = paleta, lng  = 24.7038, lat = 50, zoom = 4)
})

mapa_key_indicators <- leaflet::renderLeaflet({
 # capturamos el resultado del procesado de los inputs 
 tb <- inputs.processing.key_indicator()
 
 req(nrow(tb %>% filter(!is.na(.data[[input$Indicador_Key]]))) > 0)
 
etiquetas <-paste(
    "<strong> ", tb$Country,
    "</strong><br>", input$Indicador_Key,
    ": ",prettyNum(round(tb[[input$Indicador_Key]],digits=2), big.mark = ",", scientific = FALSE)
  )  %>%
 lapply(htmltools::HTML)

 # dibujamos el mapa 
 MapaCoropl√©tico(geoj[[1]], tb[[input$Indicador_Key]], etiquetas, "")
})
```

```{r}
tags$style(HTML("
  /* Fondo del panel del radio button */
  #mapa_vista {
    background-color: #f3e8ff; /*Color de fondo */
    padding: 10px;               /* Espacio interno */
    border-radius: 5px;          /* Bordes redondeados */
    display: inline-block;       /* Mantener inline */
  }

  /* Color del texto de cada opci√≥n */
  #mapa_vista label {
    color: #2c3e50;              /* Color del texto */
    font-weight: bold;
    margin-right: 10px;
  }

  /* Color del texto cuando la opci√≥n est√° seleccionada */
  #mapa_vista input[type='radio']:checked + label {
    color: #e74c3c;              /* Color del texto seleccionado */
  }
"))

```


```{r}
radioButtons("mapa_vista", "Selector de vista:", 
             choices = c("Employment by region", "Employment by sex & age", "Key Indicators vs. Employment"),
             inline = TRUE,
             selected = character(0))
```

```{r}
conditionalPanel(
  condition = "input.mapa_vista == 'Employment by region'",
  fluidRow(
  column(
    width = 3,
    selectInput(
    "NUTS", 
    label = "Regi√≥n NUTS:",
    choices = unique(EMPLEO$NUTS) %>% na.omit(),
    selected = 0
    ),

    selectInput(
    "A√±o", 
    label = "A√±o:",
    choices = sort(unique(EMPLEO$TIME_PERIOD), decreasing = TRUE),
    selected = 2022
    ),
    tabla_empleo_regiones
    ),

    column(
    width = 9,
    mapa_empleo_regiones 
    )
  )
)

conditionalPanel(
  condition = "input.mapa_vista == 'Employment by sex & age'",
  fluidRow(
  column(
    width = 3,
    wellPanel(
      selectInput(
      "Indicador", 
      label = "Indicador:",
      choices = c("% Mujeres" = "F", "% Hombres" = "M", "% Total" = "T", "Brecha de g√©nero (Hombres-Mujeres)" = "gender_gap"),
      selected = "gender_gap"
      ),

      selectInput(
      "Edad", 
      label = "Edad:",
      choices = unique(GENDER_GAP$age),
      selected = "Y15-24"
      ),

      selectInput(
      "NUTS_b", 
      label = "Regi√≥n NUTS:",
      choices = unique(GENDER_GAP$NUTS) %>% na.omit() %>% 
                setdiff(c("EU27_2020", "EA20")),
      selected = 0
      ),

      selectInput(
      "A√±o_b", 
      label = "A√±o:",
      choices = sort(unique(GENDER_GAP$TIME_PERIOD), decreasing = TRUE),
      selected = 2024
      ),
      
      tabla_empleo_sexo_edad
    )
  ),
  
column(
  width = 9,
  mapa_empleo_sexo_edad
)
)
)



conditionalPanel(
    condition = "input.mapa_vista == 'Key Indicators vs. Employment'",

    fluidRow(
      column(
        width = 3,
        wellPanel(
          selectInput(
            "Indicador_Key", 
            label = "Indicador:",
            choices = KEY_INDICATORS %>%      
                      select(population:emissions_total_per_capita) %>% 
                      colnames(),
            selected = "GDP_per_capita"
            ),

          selectInput(
            "A√±o_c", 
            label = "A√±o:",
            choices = sort(unique(KEY_INDICATORS$Year), decreasing = TRUE),
            selected = 2023
            ),
        tabla_key_indicators
    ),
),

      column(
        width = 9,
        mapa_key_indicators
      )
    )
)
```

```{r}
observeEvent(input$mapa_vista, {
  session$sendCustomMessage(
    type = 'resizeLeaflet',
    message = input$mapa_vista
  )
})
```


```{r}
years_key_with_data <- reactive({

  indicador <- input$Indicador_Key

  KEY_INDICATORS %>%
    select(Year, valor = all_of(indicador)) %>%
    filter(!is.na(valor)) %>%              
    group_by(Year) %>%
    summarise(n = n(), .groups="drop") %>%
    filter(n >= 10) %>%                    
    pull(Year) %>%
    sort(decreasing = TRUE)
})

# En la secci√≥n donde defines el observer, modif√≠calo as√≠:
observeEvent(input$Indicador_Key, {
  req(input$Indicador_Key)
  
  valid_years <- years_key_with_data()
  
  # Solo actualizar si el a√±o actual no est√° en los a√±os v√°lidos
  current_year <- input$A√±o_c
  if (!current_year %in% valid_years) {
    updateSelectInput(
      session,
      "A√±o_c",
      choices = valid_years,
      selected = valid_years[1]
    )
  } else {
    # Mantener el a√±o actual si es v√°lido
    updateSelectInput(
      session,
      "A√±o_c",
      choices = valid_years,
      selected = current_year
    )
  }
})
```

Column
----------------------------------


Attribute Showdown
=======================================================================

<!-- PRIMERA COLUMNA PARA SELECCI√ìN DE PAR√ÅMETROS Y MOSTRAR RESULTADOS 
  SOBRE LA REGRESI√ìN LINEAL OBTENIDA ENTRE LAS VARIABLES --> 

Column {.sidebar data-width=300}
--------------------------------------------------
```{r}
tabla_grupos_edad <- TASA_EMPLEO %>%
  filter(sex == "T", age != "Y_GE65") %>%  # Eliminar mayores de 65
  mutate(
    grupo_edad = case_when(
      age %in% c("Y15-24", "Y25-34") ~ "Y15_34",
      age %in% c("Y35-44", "Y45-54") ~ "Y35_54", 
      age %in% c("Y55-64") ~ "Y55_64",  # Solo Y55-64
      TRUE ~ "Otros"
    )
  ) %>%
  filter(grupo_edad != "Otros") %>%
  group_by(geo, TIME_PERIOD, grupo_edad) %>%
  summarise(
    emp_rate = mean(emp_rate, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(
    names_from = grupo_edad,
    values_from = emp_rate
  )


tabla_atributos <- KEY_INDICATORS %>%
  left_join(EMPLEO %>% filter(NUTS == 0, wstatus == "EMP", nace_r2 == "TOTAL"), by = c("geo", "Year" = "TIME_PERIOD")) %>%
  relocate(c("employment", "emp_per_working_age"), .after = Year) %>%
  select(-(NUTS:working_age_population)) %>%
  mutate(employment = employment * 1000, emp_per_working_age = emp_per_working_age * 100) %>%
  left_join(GENDER_GAP %>% filter(NUTS == 0, age == "Y15-64"), by = c("geo", "Year" = "TIME_PERIOD")) %>%
  relocate(c(`F`, `M`, "gender_gap"), .after = emp_per_working_age) %>%
  rename("tasa_empleo_mujeres" = `F`, "tasa_empleo_hombres" = `M`) %>%
  select(-(NUTS:`T`)) %>%
  left_join(EMPLEO_Sectores %>% filter(wstatus == "EMP", NUTS == 0) %>% group_by(sector, geo, full_name, TIME_PERIOD) %>%
              summarise(
                emp_working_age_sector = sum(emp_per_working_age) * 100
              ) %>% ungroup() %>%
            pivot_wider(names_from = sector, values_from = emp_working_age_sector), by = c("geo", "Year" = "TIME_PERIOD")) %>%
  relocate("Primario", "Secundario", "Terciario", .after = emp_per_working_age) %>%
  rename("sector_primario_per_capita" = Primario, "sector_secundario_per_capita" = Secundario, "sector_terciario_per_capita" = Terciario) %>%
  select(-full_name) %>%
  left_join(tabla_grupos_edad, by = c("geo", "Year" = "TIME_PERIOD")) %>%
  relocate(Y15_34, Y35_54, Y55_64, .after = sector_terciario_per_capita) %>%
  rename("tasa_empleo(Y15/34)" = Y15_34, "tasa_empleo(Y35/54)" = Y35_54, "tasa_empleo(Y55/64)" = Y55_64) %>%
  filter(nchar(geo) == 2)
```


```{r}
# Widgets para selecci√≥n de par√°metros 
selectInput(
  "x", 
  label = "x: atributo 1",
  choices = tabla_atributos %>%      
            select(employment:gender_gap) %>% 
            colnames(), 
  selected = "emp_per_working_age"
)

selectInput(
  "x_scale", 
  label = "Transformaci√≥n del atributo x",
  choices = c("none",
              "sqrt",    
              "log"
             ), 
  selected = "none"
)

selectInput(
  "y", 
  label = "y: atributo 2",
  choices = tabla_atributos %>%      
            select(employment:emissions_total_per_capita) %>% 
            colnames(), 
  selected = "GDP_per_capita"
)

selectInput(
  "y_scale", 
  label = "Transformaci√≥n del atributo y",
  choices = c("none",
              "log",
              "YeoJohnson"
             ), 
  selected = "none"
)

selectInput(
  "A√±o.Comparaci√≥n.Atributos", 
  label = "A√±o",
  choices = c("All", sort(unique(tabla_atributos$Year), decreasing = TRUE)), 
  selected = "2023"
)

```

```{r}
years_with_data <- reactive({

    tb <- tabla_atributos %>%
    select(Year,
           x = all_of(input$x),
           y = all_of(input$y)) %>%
    filter(!is.na(x), !is.na(y))

  tb %>%
    group_by(Year) %>%
    summarise(n = n(), .groups="drop") %>%
    filter(n >= 10) %>%        
    pull(Year) %>%
    sort(decreasing = TRUE)
})
```

```{r}
observeEvent(input$y, {

  valid_years <- years_with_data()
  current_year <- input$A√±o.Comparaci√≥n.Atributos

  selected_year <- if (current_year == "All" || current_year %in% valid_years) {
    current_year
  } else {
    valid_years[1]
  }

  updateSelectInput(
    session,
    "A√±o.Comparaci√≥n.Atributos",
    choices = c("All", valid_years),
    selected = selected_year
  )

})
```


<!-- FUNCI√ìN reactive PARA EL PROCESADO DE DATOS DE ESTA P√ÅGINA --> 

```{r}
# funci√≥n reactive que calcula los indicadores seleccionados transformados, 
# en su caso, la transformaci√≥n Yeo-Johnson entre ellos y
# la regresi√≥n lineal del resultado. 
# devuelve una lista con todo lo calculado
# hay que tener en cuenta que si input$A√±o != "Todos" hay que filtrar por el a√±o seleccionado 
inputs.processing.comparacion.atributos <- reactive( {   
  tb <-  tabla_atributos %>% 
  select(Year,Country,x=input$x,y=input$y) %>%  
  na.omit()
  
  if(input$A√±o.Comparaci√≥n.Atributos != "All"){
  tb <- tb %>% filter(Year == input$A√±o.Comparaci√≥n.Atributos)
}
    
  # transformados los indicadores de acuerdo con los par√°metros de la transformaci√≥n
  if(input$x_scale=="sqrt") tb$x <- sign(tb$x)*sqrt(abs(tb$x))
  if(input$x_scale=="log") tb$x <-  sign(tb$x)*log(abs(tb$x))
  if(input$y_scale=="log") tb$y <-  sign(tb$y)*log(abs(tb$y))
  lambda <- 1  
  if(input$y_scale=="YeoJohnson"){
    lambda <- optimize.yeojohnson.R2(tb$x, tb$y) # C√°lculo √≥ptimo modelo Yeo-Jonhson 
    tb$y <- yeo.johnson(tb$y,lambda)
  }
  
  # C√°lculo regresi√≥n lineal despu√©s de transformar las variables. 
  fit <- lm(y ~ x,data=tb)
  
  # devolvemos una lista con todo lo calculado 
  return(list(tb,fit,lambda))
})
``` 

### 

```{r}
# imprimimos en formato HTML los resultados del an√°lisis de regresi√≥n 
# de los indicadores seleccionados transformados
shiny::renderUI({
  
  # capturamos el resultado del procesado de los inputs 
  tb <- inputs.processing.comparacion.atributos()[[1]]
  fit <- inputs.processing.comparacion.atributos()[[2]]
  lambda <- inputs.processing.comparacion.atributos()[[3]]
  
  # imprimimos el resultado en formato HTML 
  text <- paste(
    "<strong>LINEAR REGRESSION ANALYSIS</strong> <br>",
    "<strong>formula:   y=ax+b </strong><br>",
    "<strong>x: Atributo 1 scaled </strong><br>",
    "<strong>y: Atributo 2 scaled </strong><br>",
    "<strong><br>RESULTS</strong><br>",
    "<strong>correlation:</strong>",round(cor(tb$x,tb$y),digits = 8),
    "<br><strong>slope (a):</strong>",formatC(fit$coefficients[2], format = "e", digits = 3),
    "<br><strong>independent (b):</strong>",formatC(fit$coefficients[1], format = "e", digits = 3)
  )
  if(input$y_scale=="YeoJohnson"){
    text <- paste(text,"<br><strong> lambda (YeoJohnson) :</strong>",formatC(lambda, format = "e", digits = 3))
  } 
  text <- paste(text,
     "<br><strong>sd(residuos):</strong>",formatC(summary(fit)$sigma, format = "e", digits = 3),
     "<br><strong>R2:</strong>",round(summary(fit)$r.squared, digits = 8)           
  )
      
  HTML(text)
})
```


<!-- NUEVA COLUMNA CON UN DIAGRAMA DE DISPERSI√ìN PARA COMPARAR LOS ATRIBUTOS TRANSFORMADOS--> 

Column
--------------------------------------------------

### Comparaci√≥n atributos transformados
```{r} 
# Diagrama de dispersi√≥n de los indicadores seleccionados transformados
# Con la recta de regresi√≥n 
renderPlotly({
  
  # capturamos el resultado del procesado de los inputs 
  # y le a√±adimos una columna con la combinaci√≥n municipio/A√±o 
  # para usarla en el desplegable
  tb <- inputs.processing.comparacion.atributos()[[1]] %>%
    mutate(`Country/Year`=paste0(Country," / ",Year)) %>%
    select(-Country)
  
  fit <- inputs.processing.comparacion.atributos()[[2]]
  slope_color <- ifelse(coef(fit)[2] < 0, "#DD5555", "#5566BB")
  
  # dibujamos el diagrama de dispersi√≥n 
  p <- tb %>%
    ggplot(aes(x,y)) + 
    geom_point(aes(color=`Country/Year`)) +
    theme(legend.position = "none") +
    labs(x= input$x, y= input$y) +
    geom_smooth(method = lm, se = FALSE, color = slope_color) 
  
  plotly::ggplotly(p)
  
})
```


<!-- NUEVA COLUMNA PARA IMPRIMIR LOS ATRIBUTOS TRANSFORMADOS--> 

Column {data-width=250}
--------------------------------------------------

### Valores atributos transformados

```{r}
# imprimimos la tabla con los valores de los indicadores seleccionados 
# ordenados por el primer indicador
renderTable({
  
  # capturamos el resultado del procesado de los inputs 
  tb <- inputs.processing.comparacion.atributos()[[1]]
  
  # imprimimos la tabla 
  tb %>% 
  arrange(desc(x)) %>% 
  mutate(Year=as.character(Year)) %>% 
  mutate(x=prettyNum(round(x,digits=2), big.mark = ",")) %>% 
  mutate(y=prettyNum(round(y,digits=2), big.mark = ","))
  
})
```




ARIMA
=======================================================================



Column {.sidebar data-width=360}
--------------------------------------------------

```{r}
# Widgets para selecci√≥n de par√°metros 
selectInput(
  "regi√≥n", 
  label = "Regi√≥n:",
  choices = unique(EMPLEO$full_name), 
  selected = c("Gran Canaria", "Tenerife"),
  multiple = TRUE,
  width = 315
)

selectInput(
  "sector", 
  label = "Sector:",
  choices = unique(EMPLEO$nace_r2.name), 
  selected = "Comercio/Transporte/Hosteler√≠a/Info-Com",
  width = 315
)


sliderInput(
  inputId = "A√±oInicialArima",
  label = "A√±o Inicial para c√°lculo ARIMA",
  min = 2000,
  max = 2015,
  value = 2010,
  step = 1,
  sep = "",
  ticks = FALSE,
  width = 315
)


numericInput(
  "Number.forecast.periods",
  label = "N. Periodos Predicci√≥n:",
  value=5,
  min=2,
  max=50,
  step=1,
  width = 315
)


selectInput(
  "ArimaParameters", 
  label = "Par√°metros ARIMA p/d/q",
  choices = c("free", "0/2/0", "1/2/1", "2/2/2", "0/1/0", "1/1/1", "2/1/2"), 
  selected = "free",
  width = 315
)
```

```{r}
EMPLEO_CLEAN <- EMPLEO %>%
  filter(!(full_name == "Canarias" & NUTS != 2)) %>%
  filter(!(full_name %in% c("Ireland", "Malta", "Luxembourg") & NUTS != 0))
  
observeEvent(input$regi√≥n, {

  regiones <- input$regi√≥n

  if (length(regiones) == 0) {
    updateSelectInput(session, "sector",
                      choices = unique(EMPLEO_CLEAN$nace_r2.name),
                      selected = NULL)
    return()
  }

  # Sectores disponibles para cada regi√≥n seleccionada
  sectores_por_region <- lapply(regiones, function(r) {
    EMPLEO_CLEAN %>%
      filter(full_name == r) %>%
      pull(nace_r2.name) %>%
      unique()
  })

  # Intersecci√≥n de sectores disponibles para TODAS las regiones seleccionadas
  sectores_validos <- Reduce(intersect, sectores_por_region)

  # Manejar casos raros: si la intersecci√≥n es vac√≠a
  if (length(sectores_validos) == 0) {
    updateSelectInput(session, "sector",
                      choices = sectores_validos,
                      selected = NULL)
    return()
  }

  # Mantener selecci√≥n si sigue siendo v√°lida
  sector_actual <- isolate(input$sector)
  if (!sector_actual %in% sectores_validos) {
    sector_actual <- sectores_validos[1]
  }

  updateSelectInput(
    session,
    "sector",
    choices = sectores_validos,
    selected = sector_actual
  )

})

# Limitar selecci√≥n a solo 2 regiones
observeEvent(input$regi√≥n, {

  regiones <- input$regi√≥n

  if (length(regiones) > 2) {
    # Nos quedamos con las dos √∫ltimas seleccionadas
    nuevas_regiones <- tail(regiones, 2)

    updateSelectInput(
      session,
      "regi√≥n",
      selected = nuevas_regiones
    )
  }

})
```


<!-- IMPRIMIMOS LAS SERIES TEMPORALES SELECCIONADAS --> 
### 

```{r}
renderTable({
  regiones_seleccionadas <- head(input$regi√≥n, 2)
  
  if (length(regiones_seleccionadas) == 0) {
    return(data.frame(Aviso = "Seleccione al menos una regi√≥n"))
  }
  
  
  tb <- EMPLEO %>%
  filter(!(full_name == "Canarias" & NUTS != 2)) %>%
  filter(!(full_name %in% c("Ireland", "Malta", "Luxembourg") & NUTS != 0))
  
  tb <- tb %>%
    filter(
      TIME_PERIOD < 2023, 
      full_name %in% regiones_seleccionadas, 
      nace_r2.name == input$sector, 
      wstatus == "EMP"
    ) %>%
    select(TIME_PERIOD, full_name, emp_per_working_age) %>% 
    na.omit() %>%
    mutate(full_name = factor(full_name, levels = regiones_seleccionadas)) %>%
    mutate(emp_per_working_age=paste(prettyNum(round(emp_per_working_age*100, 2),big.mark = "."), "%")) %>% 
    pivot_wider(names_from = full_name, values_from = emp_per_working_age) %>%
    select(TIME_PERIOD, all_of(regiones_seleccionadas)) %>%
    arrange(desc(TIME_PERIOD)) %>%
    mutate(A√±o=as.character(TIME_PERIOD)) %>%
    relocate(A√±o) %>%
    select(-TIME_PERIOD)
}, width = "100%", spacing = "l", align = "c")
```


<!-- NUEVA COLUMNA CON EL DIBUJO DE LAS PREDICCIONES PARA LAS DOS SERIES SELECCIONADAS --> 

Column 
--------------------------------------------------

### 

```{r} 
renderPlotly({
  
 req(input$regi√≥n[1], input$A√±oInicialArima, input$ArimaParameters, input$sector)
  
tb <- EMPLEO %>%
  filter(!(full_name == "Canarias" & NUTS != 2)) %>%
  filter(!(full_name %in% c("Ireland", "Malta", "Luxembourg") & NUTS != 0))
  
 ts <- tb %>%
   filter(full_name == input$regi√≥n[1], nace_r2.name == input$sector, wstatus == "EMP")  %>%
   mutate(emp_per_working_age = emp_per_working_age * 100) %>%
   as_tsibble(index=TIME_PERIOD) %>%
   fill_gaps()
 
 if(input$ArimaParameters == "free"){
   arima <- ts %>%
     filter(TIME_PERIOD >= input$A√±oInicialArima) %>%
     model(ARIMA(emp_per_working_age)) 
 } else{
   p <- as.numeric(substr(input$ArimaParameters, 1, 1))
   d <- as.numeric(substr(input$ArimaParameters, 3, 3))
   q <- as.numeric(substr(input$ArimaParameters, 5, 5))
   arima <-  ts %>%
   filter(TIME_PERIOD >= input$A√±oInicialArima) %>%
   model(ARIMA(emp_per_working_age ~ 1 + pdq(p,d,q)))
   
 }
 
 forecast <- arima %>%
   forecast(h=input$Number.forecast.periods)
 
 GraficoDinamicoArima95CI(ts, "TIME_PERIOD", "emp_per_working_age", forecast, input$regi√≥n[1])

})
```

### 


```{r} 
renderPlotly({
  
 req(input$regi√≥n[2], input$A√±oInicialArima, input$ArimaParameters, input$sector)
  
 tb <- EMPLEO %>%
  filter(!(full_name == "Canarias" & NUTS != 2)) %>%
  filter(!(full_name %in% c("Ireland", "Malta", "Luxembourg") & NUTS != 0))
  
 ts <- tb %>%
   filter(full_name == input$regi√≥n[2], nace_r2.name == input$sector, wstatus == "EMP")  %>%
   mutate(emp_per_working_age = emp_per_working_age * 100) %>%
   as_tsibble(index=TIME_PERIOD) %>%
   fill_gaps()
 
 if(input$ArimaParameters == "free"){
   arima <- ts %>%
     filter(TIME_PERIOD >= input$A√±oInicialArima) %>%
     model(ARIMA(emp_per_working_age)) 
 } else{
   p <- as.numeric(substr(input$ArimaParameters, 1, 1))
   d <- as.numeric(substr(input$ArimaParameters, 3, 3))
   q <- as.numeric(substr(input$ArimaParameters, 5, 5))
   arima <-  ts %>%
   filter(TIME_PERIOD >= input$A√±oInicialArima) %>%
   model(ARIMA(emp_per_working_age ~ 1 + pdq(p,d,q)))
   
 }
 
 forecast <- arima %>%
   forecast(h=input$Number.forecast.periods)
 
 GraficoDinamicoArima95CI(ts, "TIME_PERIOD", "emp_per_working_age", forecast, input$regi√≥n[2])

})
```



Correlation
=======================================================================
```{r}
div(
  style = "display: flex; gap: 20px; align-items: center;",
  div(
    style = "display: flex; flex-direction: row;",
    tags$label("A√±o:", style = "margin-bottom: 3px;"),
    selectInput(
      "year_matrix", 
      label = NULL,
      choices = c("Mean", rev(2000:2022)),
      selected = "Mean",
      width = "120px"
    )
  )
)
```

###

```{r}
# DIBUJAMOS LA MATRIZ DE CORRELATION USANDO LA FUNCI√ìN plot_correlation INCLUIDA EN "utilidades.R"
# CREADA CON LA AYUDA DE CHATGPT
tabla_atributos_2 <- tabla_atributos %>% select(-only_basic_education, -till_secondary_education,
                -tertiary_education, -extreme_poverty_share, -prevalence_undernourishment_share, 
                -gender_wage_gap,	-immigrant_share_of_population, -extreme_poverty_number,
                -education_expenditure_share_gdp,	-healthcare_expenditure_share_gdp, -land_use_in_hectares) %>%
                  filter(geo != "MK")
renderPlotly({
  if (input$year_matrix == "Mean") {
  tabla_atributos_2 %>%
  group_by(Country) %>%
  summarise(across(where(is.numeric), mean, na.rm = TRUE), .groups = "drop") %>%
  dplyr::select(-any_of(c("geo", "Country", "Year"))) %>% # eliminamos de la tabla las variables no-num√©ricas 
  cor(use='complete.obs') %>% # c√°lculo matriz correlaci√≥n eliminando NA previamente
  plot_correlation(show_values = TRUE) 
  }
  
  else {
    tabla_atributos_2 %>%
    filter(Year == input$year_matrix) %>%
    dplyr::select(-geo, -Country, -Year) %>% # eliminamos de la tabla las variables no-num√©ricas 
    cor(use='complete.obs') %>% # c√°lculo matriz correlaci√≥n eliminando NA previamente
    plot_correlation(show_values = TRUE) 
  }
})
```


```{r}
# PARA LAS PCA NECESITAMOS QUITAR TODOS LOS NA DE LA TABLA 
tabla_atributos_2_na_omit <- reactive({
  if (input$year_matrix == "Mean") {
    tb <- tabla_atributos_2 %>% group_by(Country) %>% summarise(across(where(is.numeric), mean, na.rm = TRUE), .groups = "drop") %>%                 select(-any_of(c("geo", "Year"))) %>% na.omit()
  }
  else {  
    tb <- tabla_atributos_2 %>% filter(Year == input$year_matrix) %>% select(-geo, -Year) %>%
          na.omit()
  }
  return(tb)
})
```

PCA
=======================================================================

Column {.tabset}
--------------------------------------------------

### Atributos originales

```{r}
shiny::renderTable({
  tabla_atributos_2_na_omit()
})
```

### Atributos estandarizados 

```{r}
# IMPRIMIMOS LAS VARIABLES ESTANDARIZADAS (SE LE RESTA LA MEDIA Y 
# SE DIVIDE POR LA DESVIACI√ìN T√çPICA) 
# PARA QUE FUNCIONE, TODOS LAS COLUMNAS DE LA TABLA DEBEN SER NUM√âRICAS Y 
# SIN NA. POR ELLO, PARA QUE LA COLUMNA location CON EL NOMBRE DEL PA√çS 
# NO GENERE ERRORES TENEMOS QUE USAR LA FUNCI√ìN column_to_rownames PARA
# QUE LA USE COMO T√çTULO DE LAS FILAS Y LAS DEJE FUERA DEL C√ÅLCULO 
shiny::renderTable({
  tb <- tabla_atributos_2_na_omit() %>% 
  column_to_rownames(var="Country") %>%
  scale() %>%
  as_tibble() %>% 
  mutate(Country=unique(tabla_atributos_2_na_omit()$Country)) %>%
  relocate(Country)
})

```



### Componentes Principales

```{r}
# CALCULAMOS COMPONENTES PRINCIPALES CON LA FUNCI√ìN prcomp
# PARA QUE FUNCIONE, TODOS LAS COLUMNAS DE LA TABLA DEBEN SER NUM√âRICAS Y 
# SIN NA. POR ELLO, PARA QUE LA COLUMNA location CON EL NOMBRE DEL PA√çS 
# NO GENERE ERRORES TENEMOS QUE USAR LA FUNCI√ìN column_to_rownames PARA
# QUE LA USE COMO T√çTULO DE LAS FILAS Y LAS DEJE FUERA DEL C√ÅLCULO DE LAS PC
pca <- reactive({
tb <- tabla_atributos_2_na_omit() %>% 
  column_to_rownames(var="Country") 

  prcomp(tb,scale = TRUE)
})
```


```{r}
# IMPRIMIMOS LAS COMPONENTES PRINCIPALES. COMO LOS NOMBRES DE LOS PA√çSES
# NO SE HAN GUARDADO AL CALCULAR pca LOS VOLVEMOS A A√ëADIR 
shiny::renderTable({
  pca()$x %>% as_tibble()  %>% 
  mutate(Country=unique(tabla_atributos_2_na_omit()$Country)) %>%
  relocate(Country)
})

```


### Pesos combinaci√≥n lineal PCA

```{r}
# IMPRIMIMOS LOS PESOS (COEFICIENTES) USADOS PARA CALCULAR LOS PC
# A PARTIR DE LAS VARIABLES ORIGINALES. 
shiny::renderTable({
  as_tibble(pca()$rotation, rownames = "variable")
})
```



### Varianza explicada


```{r} 
# DIAGRAMA DE BARRAS CON LA VARIANZA EXPLICADA
# EL N¬∫ DE PC SE PUEDE OBTENER HACIENDO length(pca$sdev)
renderPlotly({
 df <- tibble(
  label=fct_inorder(paste("PC",1:length(pca()$sdev))),
  varPercent = pca()$sdev^2/sum(pca()$sdev^2) * 100
)
 p <- df %>%
  ggplot(aes(x=label,y=varPercent, text = paste0(label, "\n", round(varPercent, 2), "%"))) +
    geom_bar(stat = "identity") +
    labs(x= "Componentes Principales", 
          y= "Porcentaje varianza explicada"
    )+
   geom_text(aes(label=paste0(round(varPercent,digits = 1),"%")), 
                 size=3,
                 colour = "blue",
                 nudge_y = 1.
             ) 
 ggplotly(p, tooltip = "text")
  
})
```


PCA Visuals
=======================================================================

```{r}
# INSERTAMOS LOS SELECTORES PARA ELEGIR LAS PC QUE SE USAR√ÅN EN EL GR√ÅFICO
tags$div(
  style = "display:flex; gap:20px; align-items:center; flex-wrap:wrap;",
  tags$div(
    style="display:flex; align-items:center; gap:6px; min-width:200px;",
    tags$label("Componente eje x", style="margin-bottom:0; white-space:nowrap;"),
    shiny::numericInput(
      "PCx",
      label = NULL,
      value= 1,
      min=1,
      max=20,
      step=1,
      width = "80px"
    )
  ),
  tags$div(
    style="display:flex; align-items:center; gap:6px; min-width:200px;",
    tags$label("Componente eje y", style="margin-bottom:0; white-space:nowrap;"),
    shiny::numericInput(
      "PCy",
      label = NULL,
      value=2,
      min=1,
      max=20,
      step=1,
      width = "80px"
    )
  )
)
```



### 

```{r} 
## DIBUJAMOS EL DIAGRAMA DE DISPERSI√ìN CON LAS PC SELECCIONADAS
highcharter::renderHighchart({
   hchart(pca(),choices=c(input$PCx,input$PCy)) %>%
  hc_tooltip(
    useHTML = TRUE,
    headerFormat = "",
    pointFormat = "<b>{point.name}</b><br>
        <b>{series.name}</b><br>
        ({point.x:.2f}, {point.y:.2f})"
  )
})
```

Canary Insights
================
Column {.tabset}
--------------------------------------------------
### Mapa de indicadores de empleo
```{r}
inputs.processing.municipios <- reactive({
  tb <- municipios.geoj.tb %>% 
    left_join(
      EMPLEO_MUNICIPIOS %>%
        select(label, geocode, !!sym(input$indicador_municipio)),
      join_by("municipio"=="label")
    )
  
  return(tb)
})
```

```{r}
div(
  style = "position: relative; width: 100%; height: 100%;",

  # Mapa
  leafletOutput("mapa_municipios", width = "100%", height = "100%"),

  # Input superpuesto
  div(
    style = "
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    ",
    selectInput(
      inputId = "indicador_municipio",
      label = NULL,
      choices = c(
        "Poblaci√≥n ocupada (total)"      = "pocu_t",
        "Poblaci√≥n ocupada (hombres)"    = "pocu_m",
        "Poblaci√≥n ocupada (mujeres)"    = "pocu_f",
        "Poblaci√≥n en b√∫squeda de empleo (total)"    = "psel_t",
        "Poblaci√≥n en b√∫squeda de empleo (hombres)"  = "psel_m",
        "Poblaci√≥n en b√∫squeda de empleo (mujeres)"  = "psel_f",
        "Tasa de empleo (total)"    = "temp_t",
        "Tasa de empleo (hombres)"  = "temp_m",
        "Tasa de empleo (mujeres)"  = "temp_f",
        "Tasa de paro (total)"      = "tpar_t",
        "Tasa de paro (hombres)"    = "tpar_m",
        "Tasa de paro (mujeres)"    = "tpar_f",
        "Tasa de asalariados (total)"    = "tsal_t",
        "Tasa de asalariados (hombres)"  = "tsal_m",
        "Tasa de asalariados (mujeres)"  = "tsal_f"
      ),
      selected = "temp_t"
    )
  )
)

```


```{r}
output$mapa_municipios <- leaflet::renderLeaflet({
 # capturamos el resultado del procesado de los inputs 
 tb <- inputs.processing.municipios()

etiquetas <-paste(
    "<strong> ",tb$municipio,
    "</strong><br>", prettyNum(round(tb[[input$indicador_municipio]],digits=2), big.mark = ",", scientific = FALSE)
  )  %>%
 lapply(htmltools::HTML)

 # dibujamos el mapa 
 map <- MapaCoropl√©tico(municipios.geoj, tb[[ input$indicador_municipio ]],etiquetas,ifelse(substr(input$indicador_municipio, 1, 1) == "p", "Poblaci√≥n", "Porcentaje"), lng = -15.5, lat = 28.1, zoom = 8) 
 
 map %>% htmlwidgets::onRender("
   function(el, x) {
     this.zoomControl.remove();
   }
 ")
})
```



### Flujo Edad ‚Üí Sexo ‚Üí Tasa de empleo

```{r}
region_ES <- TASA_EMPLEO %>% filter(NUTS == 2, substr(geo, 1, 2) == "ES")
region_ES <- unique(region_ES$full_name)

div(
  style = "display: flex; gap: 30px; align-items: center;",

  div(
    style = "display: flex; flex-direction: column;",
    tags$label("Regi√≥n", style = "margin-bottom: 5px; font-weight: bold;"),
    selectInput(
      inputId = "Region_sankey",
      label = NULL,
      choices = region_ES,
      selected = "Canarias"
    )
  ),

  div(
    style = "display: flex; flex-direction: column;",
    tags$label("A√±o", style = "margin-bottom: 5px; font-weight: bold;"),
    selectInput(
      inputId = "A√±o_sankey",
      label = NULL,
      choices = sort(unique(TASA_EMPLEO$TIME_PERIOD)),
      selected = 2022
    )
  )
)

```

```{r}
renderPlotly({
    tb <- TASA_EMPLEO %>% filter(NUTS == 2, full_name == input$Region_sankey, sex != "T", age != "Y15-64")

  # --- Filtrar a√±o ---
  tb <- tb %>% filter(TIME_PERIOD == input$A√±o_sankey)

  # --- Reescalar la tasa para que el Sankey sea legible ---
  tb <- tb %>% mutate(value = emp_rate)   # puedes dividir entre 1 √≥ multiplicar si quieres m√°s grosor

  # --- Preparar nodos ---
  nodes <- data.frame(
    name = c(
      unique(tb$age),
      unique(tb$sex)
    )
  )

  # --- Preparar enlaces edad ‚Üí sexo ---
  links <- tb %>%
    mutate(
      source = match(age, nodes$name) - 1,
      target = match(sex, nodes$name) - 1
    ) %>%
    group_by(source, target) %>%
    summarise(value = sum(value, na.rm = TRUE), .groups = "drop")
  

  # --- Construcci√≥n del Sankey ---
  plot_ly(
    type = "sankey",
    arrangement = "snap",
    node = list(
      label = nodes$name,
      pad = 15,
      thickness = 20
    ),
    link = list(
      source = links$source,
      target = links$target,
      value = links$value
    )
  ) %>%
    layout(
      title = paste("Flujo edad ‚Üí sexo ‚Üí tasa de empleo (", input$A√±o_sankey, ")", sep = ""),
      font = list(size = 12),
      margin = list(l = 20, r = 20, b = 90, t = 40)
    )
})

```

### Inserci√≥n laboral: FP vs Grado
```{r}
div(
  style = "display: flex; align-items: center; gap: 20px;",
  
  # Selector de A√±o
  div(
    style = "display: flex; flex-direction: row; align-items: flex-start;",
    tags$label("A√±o: ", style = "margin-right: 5px"),
    selectInput(
      "a√±o_spider",
      label = NULL,
      choices = sort(unique(INSERCION_LABORAL$TIME_PERIOD_CODE)),
      selected = "2023",
      width = "120px"
    )
  )
)
```

```{r}
renderPlotly({
  req(input$a√±o_spider)
  
  datos_a√±o <- INSERCION_LABORAL %>%
    filter(TIME_PERIOD_CODE == as.numeric(input$a√±o_spider)) %>%
    mutate(rama_clean = str_replace_all(RAMA_ENSENIANZA_CODE, "_", " "))
  
  plot_ly(type = 'scatterpolar') %>%
    # Grado PRIMERO (fondo - colores claros)
    add_trace(
      r = ~c(datos_a√±o$TASA_GRADO, datos_a√±o$TASA_GRADO[1]),
      theta = ~c(datos_a√±o$rama_clean, datos_a√±o$rama_clean[1]),
      fill = 'toself',
      name = 'Grado Universitario',
      fillcolor = 'rgba(173, 216, 230, 0.6)',  # Azul claro
      line = list(color = 'rgba(70, 130, 180, 0.9)', width = 2.5),  # Azul oscuro para puntos
      marker = list(
        symbol = 'circle',
        size = 6,
        color = 'rgba(70, 130, 180, 1)'  # Azul oscuro para marcadores
      ),
      hovertemplate = '<b>%{theta}</b><br>Grado: <b>%{r:.1f}%</b><extra></extra>'
    ) %>%
    # FP SEGUNDO (encima - colores claros)
    add_trace(
      r = ~c(datos_a√±o$TASA_FP, datos_a√±o$TASA_FP[1]),
      theta = ~c(datos_a√±o$rama_clean, datos_a√±o$rama_clean[1]),
      fill = 'toself',
      name = 'Formaci√≥n Profesional',
      fillcolor = 'rgba(255, 182, 193, 0.6)',  # Rosa claro
      line = list(color = 'rgba(219, 112, 147, 0.9)', width = 2.5),  # Rosa oscuro para puntos
      marker = list(
        symbol = 'circle',
        size = 6,
        color = 'rgba(219, 112, 147, 1)'  # Rosa oscuro para marcadores
      ),
      hovertemplate = '<b>%{theta}</b><br>FP: <b>%{r:.1f}%</b><extra></extra>'
    ) %>%
    layout(
      polar = list(
        radialaxis = list(
          visible = TRUE, 
          range = c(0, 80),
          tickvals = c(0, 20, 40, 60, 80),
          ticktext = c("0%", "20%", "40%", "60%", "80%"),
          gridcolor = 'rgba(200, 200, 200, 0.3)',
          linecolor = 'rgba(150, 150, 150, 0.5)'
        ),
        angularaxis = list(
          gridcolor = 'rgba(200, 200, 200, 0.3)',
          linecolor = 'rgba(150, 150, 150, 0.5)'
        ),
        bgcolor = 'rgba(248, 249, 250, 0.3)'
      ),
      showlegend = TRUE,
      title = list(
        text = paste("<b>Comparativa por Rama de Ense√±anza - A√±o", input$a√±o_spider, "</b>"),
        font = list(size = 16, color = '#2c3e50')
      ),
      legend = list(
        orientation = "h",
        x = 0.5,
        xanchor = "center",
        y = -0.05,  # M√°s espacio abajo
        yanchor = "top",
        font = list(size = 12, color = '#2c3e50'),
        bgcolor = 'rgba(255, 255, 255, 0.8)',
        borderwidth = 1
      ),
      paper_bgcolor = 'rgba(255, 255, 255, 0.9)',
      plot_bgcolor = 'rgba(255, 255, 255, 0.8)',
      margin = list(t = 80, b = 120, l = 80, r = 80)  # M√°s margen inferior
    )
})
```

### Evoluci√≥n de contratos por tipo

```{r}
div(
  style = "display: flex; align-items: center; gap: 20px;",
  
  # Selector de A√±o
  div(
    style = "display: flex; flex-direction: row; align-items: flex-start;",
    tags$label("A√±o: ", style = "margin-right: 5px"),
    selectInput(
      "a√±os",
      label = NULL,
      choices = sort(unique(CONTRATOS_2018_2024$a√±o)),
      selected = "2024",
      width = "120px"
    )
  ),
  
  # Selector de Sexo
  div(
    style = "display: flex; flex-direction: row; align-items: flex-start;",
    tags$label("Sexo: ", style = "margin-right: 5px"),
    selectInput(
      "sexo",
      label = NULL,
      choices = sort(unique(CONTRATOS_2018_2024$sexo)),
      selected = "Hombres",
      width = "120px"
    )
  ),
  
  # Selector de Edad
  div(
    style = "display: flex; flex-direction: row; align-items: flex-start;",
    tags$label("Edad: ", style = "margin-right: 5px"),
    selectInput(
      "edad",
      label = NULL,
      choices = sort(unique(CONTRATOS_2018_2024$edad)),
      selected = "Entre 25 y 44",
      width = "160px"
    )
  ),
  
  # Selector de Islas
  div(
    style = "display: flex; flex-direction: row; align-items: flex-start;",
    tags$label("Islas: ", style = "margin-right: 5px"),
    selectInput(
      "islas", 
      label = NULL,
      choices = unique(CONTRATOS_2018_2024$isla),
      selected = c("GRAN CANARIA", "TENERIFE", "FUERTEVENTURA", "LANZAROTE"),
      multiple = TRUE,
      width = "600px"
    )
  )
)
```

```{r}
renderPlotly({
  req(input$islas[1])
  tb <- CONTRATOS_2018_2024 %>% 
    filter(
      isla %in% input$islas,
      sexo %in% input$sexo,
      edad %in% input$edad,
      a√±o %in% input$a√±os
    ) %>% 
    mutate(
      mes = as.integer(mes), 
      fecha = as.Date(paste(a√±o, mes, "01", sep = "-"))
    ) %>%
    group_by(isla, fecha, mes, Tipo.Contrato) %>%
    summarise(Contratos = sum(Contratos), .groups = "drop") %>%
    group_by(isla, fecha, mes) %>%
    mutate(
      percentage = Contratos / sum(Contratos) * 100,
      Total_Contratos = sum(Contratos)
    ) %>%
    ungroup() %>%
    arrange(isla, fecha, Tipo.Contrato)
  
  g <- tb %>%
    ggplot(aes(
      x = fecha,
      y = percentage,
      fill = Tipo.Contrato
    )) +
    geom_area(alpha = 0.85, position = "stack") +
    # Puntos invisibles solo para tooltips
    geom_point(aes(text = paste0(
      "Fecha: ", format(fecha, "%b %Y"), "<br>",
      "Tipo: ", Tipo.Contrato, "<br>",
      "Porcentaje: ", round(percentage, 1), "%<br>",
      "Contratos: ", format(Contratos, big.mark = ","), "<br>",
      "Total mes: ", format(Total_Contratos, big.mark = ",")
    )), size = 0, alpha = 0) +
    facet_wrap(~ isla, scales = "free_y") +
    scale_fill_viridis_d(option = "D") +
    scale_y_continuous(labels = scales::percent_format(scale = 1)) +
    theme_minimal() +
    labs(x = "", y = "") +
    theme(
      legend.position = "bottom",
      panel.spacing = unit(0.2, "lines")
    )
  
    ggplotly(g, tooltip = "text") %>%
    layout(
      margin = list(l = 60, r = 20, b = 80, t = 40),
      hovermode = "x unified",
      legend = list(
        orientation = "h",
        x = 0.5,
        xanchor = "center",
        y = -0.1,
        yanchor = "top"
      )
    )
})
```


```{r}
# Coloca esto AL FINAL de tu dashboard, despu√©s de todo el contenido
tags$script(HTML("
  // Funci√≥n espec√≠fica para redimensionar Leaflet
  function forceLeafletResize() {
    // Esperar a que se renderice el DOM
    setTimeout(function() {
      // Buscar todos los mapas Leaflet
      var leafletMaps = document.querySelectorAll('.leaflet');
      
      leafletMaps.forEach(function(mapDiv) {
        // Encontrar el mapa Leaflet real
        var map = mapDiv._leaflet_map;
        if (!map && mapDiv.leaflet) {
          map = mapDiv.leaflet;
        }
        
        // Intentar obtener el mapa de diferentes maneras
        if (!map && typeof L !== 'undefined') {
          var maps = L.Map.getAll();
          for (var key in maps) {
            if (maps[key]._container === mapDiv) {
              map = maps[key];
              break;
            }
          }
        }
        
        // Forzar redimensionamiento
        if (map && typeof map.invalidateSize === 'function') {
          // Primero forzar que el contenedor tenga tama√±o
          $(mapDiv).css({
            'width': '100%',
            'height': '100%'
          });
          
          // Redimensionar el mapa
          map.invalidateSize(true);
          
          // Segundo intento despu√©s de un peque√±o delay
          setTimeout(function() {
            map.invalidateSize(true);
          }, 100);
        }
      });
    }, 300);
  }
  
  // Ejecutar cuando se carga la p√°gina
  $(document).ready(function() {
    // Primer ajuste
    setTimeout(forceLeafletResize, 500);
    
    // Ajustar cuando cambia el tama√±o de la ventana
    $(window).on('resize', function() {
      forceLeafletResize();
    });
    
    // Ajustar cuando cambian las pesta√±as/tabs
    $('a[data-toggle=\"tab\"]').on('shown.bs.tab', function() {
      setTimeout(forceLeafletResize, 300);
    });
  });
  
  // Observer espec√≠fico para tu radio button
  $(document).on('change', '#mapa_vista input', function() {
    // Esperar a que se cambie el conditionalPanel
    setTimeout(function() {
      forceLeafletResize();
    }, 400);
  });
  
  // Tambi√©n disparar cuando Shiny termina de actualizar
  $(document).on('shiny:value', function(event) {
    if (event.target.id && event.target.id.includes('mapa')) {
      setTimeout(forceLeafletResize, 200);
    }
  });
"))
```

